<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header .stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
            
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn-sm {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            /* –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .table-responsive table,
            .table-responsive thead,
            .table-responsive tbody,
            .table-responsive th,
            .table-responsive td,
            .table-responsive tr {
                display: block;
            }
            
            .table-responsive thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-responsive tr {
                border: 1px solid #e0e0e0;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }
            
            .table-responsive td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: left;
            }
            
            .table-responsive td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                font-weight: 600;
                color: #666;
            }
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: #d4edda; color: #155724; }
        .badge.pending { background: #fff3cd; color: #856404; }
        .badge.failed { background: #f8d7da; color: #721c24; }
        .badge.processing { background: #d1ecf1; color: #0c5460; }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .link {
            color: #667eea;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-card h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .telegram-login-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .telegram-login-button:hover {
            background: #006ba3;
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h2>
            <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <div id="telegram-login-container"></div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="mainContent" class="hidden">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                <div class="value" id="stat-users">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ó–∞–∫–∞–∑—ã</div>
                <div class="value" id="stat-orders">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–í—ã—Ä—É—á–∫–∞</div>
                <div class="value" id="stat-revenue">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <div class="value" id="stat-generations">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab" onclick="switchTab('orders')">üì¶ –ó–∞–∫–∞–∑—ã</button>
            <button class="tab" onclick="switchTab('payments')">üí≥ –ü–ª–∞—Ç–µ–∂–∏</button>
            <button class="tab" onclick="switchTab('jobs')">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
            <button class="tab" onclick="switchTab('analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        </div>

        <div class="content">
            <div id="content-users" class="tab-content">
                <div class="search-box">
                    <input type="text" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, –∏–º–µ–Ω–∏ –∏–ª–∏ telegram_id..." oninput="searchUsers()">
                </div>
                <div id="users-table"></div>
            </div>

            <div id="content-orders" class="tab-content" style="display: none;">
                <div id="orders-table"></div>
            </div>

            <div id="content-payments" class="tab-content" style="display: none;">
                <div id="payments-table"></div>
            </div>

            <div id="content-jobs" class="tab-content" style="display: none;">
                <div id="jobs-table"></div>
            </div>

            <div id="content-analytics" class="tab-content" style="display: none;">
                <div id="analytics-content"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π -->
    <div class="modal" id="editGenerationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
                <p id="edit-user-info"></p>
            </div>
            <div class="form-group">
                <label>–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:</label>
                <input type="number" id="edit-generations-input" min="0">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveGenerations()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('editGenerationsModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h2>
                <p id="delete-user-info"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('deleteUserModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <p id="history-user-info"></p>
            </div>
            <div id="history-content" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('historyModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'users';
        let currentPage = { users: 1, orders: 1, payments: 1, jobs: 1 };
        let currentData = {};
        let searchTimeout = null;
        let isAuthenticated = false;
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                if (data.authenticated) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                showLoginScreen();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            initTelegramLogin();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        function showMainContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = `@${currentUser.username || currentUser.telegram_id}`;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Widget Login
        async function initTelegramLogin() {
            const container = document.getElementById('telegram-login-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º bot username —á–µ—Ä–µ–∑ API
                const response = await fetch('/api/bot-username');
                const data = await response.json();
                const botUsername = data.botUsername;
                
                if (!botUsername) {
                    container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞: Bot username –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>';
                    return;
                }
                
                container.innerHTML = '';
                const script = document.createElement('script');
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
                script.src = 'https://telegram.org/js/telegram-widget.js?22&t=' + Date.now();
                script.setAttribute('data-telegram-login', botUsername);
                script.setAttribute('data-size', 'large');
                script.setAttribute('data-userpic', 'false');
                script.setAttribute('data-request-access', 'write');
                // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ auth-url –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                script.setAttribute('data-auth-url', window.location.origin + '/api/auth/telegram?t=' + Date.now());
                script.setAttribute('data-onauth', 'onTelegramAuth(user)');
                script.async = true;
                container.appendChild(script);
            } catch (error) {
                container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞: ' + error.message + '</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        async function onTelegramAuth(user) {
            try {
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });

                const data = await response.json();
                if (data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }


        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                await fetch('/api/auth/logout', { method: 'POST' });
                
                // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                isAuthenticated = false;
                currentUser = null;
                
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Telegram Widget –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –µ–≥–æ
                const container = document.getElementById('telegram-login-container');
                if (container) {
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–≤–∫–ª—é—á–∞—è —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞)
                    container.innerHTML = '';
                }
                
                // –û—á–∏—â–∞–µ–º cookies (–µ—Å–ª–∏ –µ—Å—Ç—å)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // –û—á–∏—â–∞–µ–º localStorage –∏ sessionStorage (Telegram Widget –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö)
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                }
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
                setTimeout(() => {
                    showLoginScreen();
                }, 100);
            } catch (error) {
                console.error('Logout error:', error);
                // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const container = document.getElementById('telegram-login-container');
                if (container) {
                    container.innerHTML = '';
                }
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {}
                // –í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                setTimeout(() => {
                    showLoginScreen();
                }, 100);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('stat-users').textContent = stats.total_users || 0;
                document.getElementById('stat-orders').textContent = stats.completed_orders || 0;
                document.getElementById('stat-revenue').textContent = `${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ`;
                document.getElementById('stat-generations').textContent = stats.total_generations || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`content-${tab}`).style.display = 'block';
            
            loadTabData(tab);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏
        async function loadTabData(tab) {
            let container;
            if (tab === 'analytics') {
                container = document.getElementById('analytics-content');
            } else {
                container = document.getElementById(`${tab}-table`);
            }
            
            if (!container) {
                console.error(`Container not found for tab: ${tab}`);
                return;
            }
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                let response;
                
                switch(tab) {
                    case 'users':
                        response = await fetch(`/api/users?page=${currentPage.users}&limit=50`);
                        const usersData = await response.json();
                        currentData.users = usersData;
                        renderUsers(usersData);
                        break;
                    case 'orders':
                        response = await fetch(`/api/orders?page=${currentPage.orders}&limit=50`);
                        const ordersData = await response.json();
                        currentData.orders = ordersData;
                        renderOrders(ordersData);
                        break;
                    case 'payments':
                        response = await fetch(`/api/payments?page=${currentPage.payments}&limit=50`);
                        const paymentsData = await response.json();
                        currentData.payments = paymentsData;
                        renderPayments(paymentsData);
                        break;
                    case 'jobs':
                        response = await fetch(`/api/did-jobs?page=${currentPage.jobs}&limit=50`);
                        const jobsData = await response.json();
                        currentData.jobs = jobsData;
                        renderJobs(jobsData);
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                }
            } catch (error) {
                if (container) {
                    container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
                }
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = document.getElementById('search-users').value;
                loadUsers(search);
            }, 300);
        }

        async function loadUsers(search = '') {
            const container = document.getElementById('users-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const url = search 
                    ? `/api/users?page=${currentPage.users}&limit=50&search=${encodeURIComponent(search)}`
                    : `/api/users?page=${currentPage.users}&limit=50`;
                
                const response = await fetch(url);
                const data = await response.json();
                currentData.users = data;
                renderUsers(data);
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsers(data) {
            const container = document.getElementById('users-table');
            
            if (!data.users || data.users.length === 0) {
                container.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Telegram ID</th>
                                <th>Username</th>
                                <th>–ò–º—è</th>
                                <th>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</th>
                                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.telegram_id}</td>
                        <td>@${user.username || '-'}</td>
                        <td>${user.first_name || '-'} ${user.last_name || ''}</td>
                        <td>${user.generations || 0}</td>
                        <td class="timestamp">${new Date(user.created_at).toLocaleString('ru-RU')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editGenerations(${user.id}, '${user.username || user.first_name || 'User'}', ${user.generations || 0})">–ò–∑–º–µ–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.username || user.first_name || 'User'}')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn btn-primary btn-sm" onclick="viewUserHistory(${user.id})">–ò—Å—Ç–æ—Ä–∏—è</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('users', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤
        function renderOrders(data) {
            const container = document.getElementById('orders-table');
            
            if (!data.orders || data.orders.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¶–µ–Ω–∞</th>
                                <th>–ü—Ä–æ–º–ø—Ç</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.orders.forEach((order, index) => {
                const priceDisplay = order.price === 0 || order.price === null ? '1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è' : `${order.price} ‚ÇΩ`;
                const promptId = `prompt-${order.id}-${index}`;
                const promptText = order.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è';
                const isLongPrompt = promptText.length > 30;
                const shortPrompt = isLongPrompt ? promptText.substring(0, 30) + '...' : promptText;
                
                html += `
                    <tr>
                        <td><a href="#" onclick="viewOrderDetails('${order.id}')" class="link">${order.id.substring(0, 8)}...</a></td>
                        <td>@${order.username || order.telegram_id || '-'}</td>
                        <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                        <td>${priceDisplay}</td>
                        <td>
                            <span id="${promptId}-short">${shortPrompt}</span>
                            ${isLongPrompt ? `
                                <span id="${promptId}-full" style="display: none;">${promptText}</span>
                                <button class="btn btn-primary btn-sm" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="togglePrompt('${promptId}')">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                            ` : ''}
                        </td>
                        <td class="timestamp">${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('orders', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
        function renderPayments(data) {
            const container = document.getElementById('payments-table');
            
            if (!data.payments || data.payments.length === 0) {
                container.innerHTML = '<div class="empty">–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>YooMoney ID</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.payments.forEach(payment => {
                html += `
                    <tr>
                        <td>${payment.id.substring(0, 8)}...</td>
                        <td>@${payment.username || payment.telegram_id || '-'}</td>
                        <td>${payment.amount} ‚ÇΩ</td>
                        <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                        <td>${payment.yoomoney_payment_id || '-'}</td>
                        <td class="timestamp">${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('payments', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞–Ω–∏–π
        function renderJobs(data) {
            const container = document.getElementById('jobs-table');
            
            if (!data.jobs || data.jobs.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–º–ø—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–û—à–∏–±–∫–∞</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.jobs.forEach((job, index) => {
                const promptId = `job-prompt-${job.id}-${index}`;
                const promptText = job.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è';
                const isLongPrompt = promptText.length > 30;
                const shortPrompt = isLongPrompt ? promptText.substring(0, 30) + '...' : promptText;
                
                html += `
                    <tr>
                        <td>${job.id.substring(0, 8)}...</td>
                        <td>@${job.username || job.telegram_id || '-'}</td>
                        <td>
                            <span id="${promptId}-short">${shortPrompt}</span>
                            ${isLongPrompt ? `
                                <span id="${promptId}-full" style="display: none;">${promptText}</span>
                                <button class="btn btn-primary btn-sm" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="togglePrompt('${promptId}')">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                            ` : ''}
                        </td>
                        <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                        <td>${job.result_url ? `<a href="${job.result_url}" target="_blank" class="link">–°–º–æ—Ç—Ä–µ—Ç—å</a>` : '-'}</td>
                        <td>${job.error_message ? `<span style="color: red;">${job.error_message.substring(0, 50)}...</span>` : '-'}</td>
                        <td class="timestamp">${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('jobs', data);
            }
            
            container.innerHTML = html;
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function renderPagination(tab, data) {
            const totalPages = Math.ceil(data.total / 50);
            return `
                <div class="pagination">
                    <button ${currentPage[tab] === 1 ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] - 1})">‚Äπ –ù–∞–∑–∞–¥</button>
                    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage[tab]} –∏–∑ ${totalPages} (–≤—Å–µ–≥–æ: ${data.total})</span>
                    <button ${currentPage[tab] >= totalPages ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] + 1})">–í–ø–µ—Ä—ë–¥ ‚Ä∫</button>
                </div>
            `;
        }

        function changePage(tab, page) {
            currentPage[tab] = page;
            loadTabData(tab);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusBadge(status) {
            const statusMap = {
                'completed': 'success',
                'succeeded': 'success',
                'success': 'success',
                'pending': 'pending',
                'processing': 'processing',
                'failed': 'failed',
                'running': 'processing',
                'canceled': 'failed',
                'cancelled': 'failed'
            };
            return statusMap[status?.toLowerCase()] || 'pending';
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
        let editingUserId = null;
        function editGenerations(userId, userName, currentGenerations) {
            editingUserId = userId;
            document.getElementById('edit-user-info').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName} (–¢–µ–∫—É—â–µ–µ: ${currentGenerations})`;
            document.getElementById('edit-generations-input').value = currentGenerations;
            document.getElementById('editGenerationsModal').classList.add('active');
        }

        async function saveGenerations() {
            const newValue = parseInt(document.getElementById('edit-generations-input').value);
            
            if (isNaN(newValue) || newValue < 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
                return;
            }

            try {
                const response = await fetch(`/api/users/${editingUserId}/generations`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ generations: newValue })
                });

                if (response.ok) {
                    closeModal('editGenerationsModal');
                    loadUsers();
                    loadStats();
                    alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let deletingUserId = null;
        function deleteUser(userId, userName) {
            deletingUserId = userId;
            document.getElementById('delete-user-info').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        async function confirmDeleteUser() {
            try {
                const response = await fetch(`/api/users/${deletingUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeModal('deleteUserModal');
                    loadUsers();
                    loadStats();
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞
        function togglePrompt(promptId) {
            const shortEl = document.getElementById(`${promptId}-short`);
            const fullEl = document.getElementById(`${promptId}-full`);
            const button = event.target;
            
            if (shortEl && fullEl && button) {
                if (shortEl.style.display === 'none') {
                    shortEl.style.display = 'inline';
                    fullEl.style.display = 'none';
                    button.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
                } else {
                    shortEl.style.display = 'none';
                    fullEl.style.display = 'inline';
                    button.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function viewUserHistory(userId) {
            try {
                document.getElementById('historyModal').classList.add('active');
                const content = document.getElementById('history-content');
                content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const response = await fetch(`/api/users/${userId}/history`);
                const history = await response.json();
                
                const user = history.user;
                document.getElementById('history-user-info').textContent = 
                    `@${user.username || user.telegram_id} | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(user.created_at).toLocaleString('ru-RU')} | –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${user.generations || 0}`;
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üì¶ –ó–∞–∫–∞–∑—ã (${history.orders.length})</h3>
                        ${history.orders.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–¶–µ–Ω–∞</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.orders.map(order => `
                                            <tr>
                                                <td>${order.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                                                <td>${order.price || 0} ‚ÇΩ</td>
                                                <td>${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üí≥ –ü–ª–∞—Ç–µ–∂–∏ (${history.payments.length})</h3>
                        ${history.payments.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–°—É–º–º–∞</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.payments.map(payment => `
                                            <tr>
                                                <td>${payment.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                                                <td>${payment.amount} ‚ÇΩ</td>
                                                <td>${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üé¨ –ó–∞–¥–∞–Ω–∏—è (${history.jobs.length})</h3>
                        ${history.jobs.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.jobs.map(job => `
                                            <tr>
                                                <td>${job.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                                                <td>${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</p>'}
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                document.getElementById('history-content').innerHTML = 
                    `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        async function loadAnalytics() {
            const container = document.getElementById('analytics-content');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>';
            
            try {
                const [campaignsResponse, statsResponse] = await Promise.all([
                    fetch('/api/analytics/campaigns'),
                    fetch('/api/stats')
                ]);
                
                const campaigns = await campaignsResponse.json();
                const stats = await statsResponse.json();
                
                renderAnalytics(campaigns, stats);
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ${error.message}</div>`;
            }
        }

        function renderAnalytics(campaigns, stats) {
            const container = document.getElementById('analytics-content');
            
            let html = `
                <h2 style="margin-bottom: 20px;">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–í—ã—Ä—É—á–∫–∞</div>
                        <div style="font-size: 24px; font-weight: bold;">${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–£—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.successful_payments || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.completed_orders || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ü—Ä–æ–≤–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.failed_orders || 0}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                    <div>
                        <h3 style="margin-bottom: 15px;">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–æ–≤</h3>
                        <canvas id="ordersChart" width="400" height="200"></canvas>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px;">–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏–π</h3>
                        <canvas id="jobsChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <h2 style="margin-bottom: 20px; margin-top: 40px;">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h2>
                ${campaigns.length > 0 ? `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚≠ê)</th>
                                    <th>–ó–∞–∫–∞–∑—ã</th>
                                    <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(c => `
                                    <tr>
                                        <td>${c.campaign_name || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏'}</td>
                                        <td>${c.total_users || 0}</td>
                                        <td>${parseFloat(c.total_payments_rub || 0).toFixed(2)}</td>
                                        <td>${c.total_payments_stars || 0}</td>
                                        <td>${c.completed_orders || 0}</td>
                                        <td>${parseFloat(c.conversion_rate || 0).toFixed(2)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${campaigns.length > 0 ? `
                        <div style="margin-top: 40px;">
                            <h3 style="margin-bottom: 15px;">–í—ã—Ä—É—á–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h3>
                            <canvas id="campaignsChart" width="400" height="300"></canvas>
                        </div>
                    ` : ''}
                ` : '<p style="color: #999;">–î–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º –Ω–µ—Ç</p>'}
            `;
            
            container.innerHTML = html;
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º
            setTimeout(() => {
                drawOrdersChart(stats);
                drawJobsChart(stats);
                if (campaigns.length > 0) {
                    drawCampaignsChart(campaigns);
                }
            }, 100);
        }

        function drawOrdersChart(stats) {
            const canvas = document.getElementById('ordersChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const completed = stats.completed_orders || 0;
            const failed = stats.failed_orders || 0;
            const total = completed + failed || 1;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 60;
            
            // –û—á–∏—Å—Ç–∫–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ö—Ä—É–≥ –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö
            const completedAngle = (completed / total) * 2 * Math.PI;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, 0, completedAngle);
            ctx.closePath();
            ctx.fillStyle = '#d4edda';
            ctx.fill();
            
            // –ö—Ä—É–≥ –¥–ª—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, completedAngle, 2 * Math.PI);
            ctx.closePath();
            ctx.fillStyle = '#f8d7da';
            ctx.fill();
            
            // –ü–æ–¥–ø–∏—Å–∏
            ctx.fillStyle = '#333';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${completed}`, centerX, centerY - 10);
            ctx.fillText(`–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${failed}`, centerX, centerY + 10);
        }

        function drawJobsChart(stats) {
            const canvas = document.getElementById('jobsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const completed = stats.completed_jobs || 0;
            const failed = stats.failed_jobs || 0;
            const total = completed + failed || 1;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 60;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const completedAngle = (completed / total) * 2 * Math.PI;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, 0, completedAngle);
            ctx.closePath();
            ctx.fillStyle = '#d4edda';
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, completedAngle, 2 * Math.PI);
            ctx.closePath();
            ctx.fillStyle = '#f8d7da';
            ctx.fill();
            
            ctx.fillStyle = '#333';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${completed}`, centerX, centerY - 10);
            ctx.fillText(`–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${failed}`, centerX, centerY + 10);
        }

        function drawCampaignsChart(campaigns) {
            const canvas = document.getElementById('campaignsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const maxRevenue = Math.max(...campaigns.map(c => parseFloat(c.total_payments_rub || 0)), 1);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = canvas.width / (campaigns.length + 1);
            const maxHeight = canvas.height - 60;
            
            campaigns.forEach((campaign, index) => {
                const revenue = parseFloat(campaign.total_payments_rub || 0);
                const barHeight = (revenue / maxRevenue) * maxHeight;
                const x = (index + 1) * barWidth;
                const y = canvas.height - barHeight - 40;
                
                ctx.fillStyle = '#667eea';
                ctx.fillRect(x - barWidth/2 + 10, y, barWidth - 20, barHeight);
                
                ctx.fillStyle = '#333';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(
                    (campaign.campaign_name || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏').substring(0, 15),
                    x, canvas.height - 20
                );
                ctx.fillText(
                    `${revenue.toFixed(0)}‚ÇΩ`,
                    x, y - 5
                );
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkAuth();
    </script>
</body>
</html>

