<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header .stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .filters-container select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .filter-tag .filter-label {
            font-weight: 600;
        }

        .filter-tag .filter-value {
            font-weight: 400;
        }

        .filter-tag .filter-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .filter-tag .filter-remove:hover {
            opacity: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
            
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn-sm {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            /* –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .table-responsive table,
            .table-responsive thead,
            .table-responsive tbody,
            .table-responsive th,
            .table-responsive td,
            .table-responsive tr {
                display: block;
            }
            
            .table-responsive thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-responsive tr {
                border: 1px solid #e0e0e0;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }
            
            .table-responsive td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: left;
            }
            
            .table-responsive td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                font-weight: 600;
                color: #666;
            }

            /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
            .analytics-stats {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            .analytics-charts {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .analytics-chart-container {
                padding: 15px !important;
            }

            .analytics-chart-container canvas {
                max-height: 250px !important;
            }
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: #d4edda; color: #155724; }
        .badge.pending { background: #fff3cd; color: #856404; }
        .badge.failed { background: #f8d7da; color: #721c24; }
        .badge.processing { background: #d1ecf1; color: #0c5460; }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .toast-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .link {
            color: #667eea;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-card h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .telegram-login-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .telegram-login-button:hover {
            background: #006ba3;
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h2>
            <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <div id="telegram-login-container"></div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="mainContent" class="hidden">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                <div class="value" id="stat-users">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ó–∞–∫–∞–∑—ã</div>
                <div class="value" id="stat-orders">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–í—ã—Ä—É—á–∫–∞</div>
                <div class="value" id="stat-revenue">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <div class="value" id="stat-generations">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="tab" onclick="switchTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab" onclick="switchTab('orders')">üì¶ –ó–∞–∫–∞–∑—ã</button>
            <button class="tab" onclick="switchTab('payments')">üí≥ –ü–ª–∞—Ç–µ–∂–∏</button>
            <button class="tab" onclick="switchTab('jobs')">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
            <button class="tab" onclick="switchTab('analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            <button class="tab" onclick="switchTab('logs')">üìã –õ–æ–≥–∏</button>
        </div>

        <div class="content">
            <div id="content-dashboard" class="tab-content" style="display: block;">
                <!-- –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div id="summary-stats" style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0; font-size: 20px;">üìä –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="summary-campaign-filter" style="font-size: 14px; color: #666;">–ö–∞–º–ø–∞–Ω–∏—è:</label>
                            <select id="summary-campaign-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer; min-width: 200px;">
                                <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                            </select>
                        </div>
                    </div>
                    <div id="summary-content"></div>
                </div>
            </div>
            
            <div id="content-users" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, –∏–º–µ–Ω–∏ –∏–ª–∏ telegram_id..." 
                           oninput="searchUsers()"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-users-campaign" onchange="applyUsersFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div id="active-filters-users" class="active-filters"></div>
                <div id="users-table"></div>
            </div>

            <div id="content-orders" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-orders-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ id..." 
                           oninput="clearTimeout(orderSearchTimeout); orderSearchTimeout = setTimeout(() => loadOrders(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-orders-campaign" onchange="applyOrdersFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div id="active-filters-orders" class="active-filters"></div>
                <div id="orders-table"></div>
            </div>

            <div id="content-payments" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-payments-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ id..." 
                           oninput="clearTimeout(paymentSearchTimeout); paymentSearchTimeout = setTimeout(() => loadPayments(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-payments-campaign" onchange="applyPaymentsFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div id="active-filters-payments" class="active-filters"></div>
                <div id="payments-table"></div>
            </div>

            <div id="content-jobs" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-jobs-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ id..." 
                           oninput="clearTimeout(jobSearchTimeout); jobSearchTimeout = setTimeout(() => loadJobs(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-jobs-campaign" onchange="applyJobsFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div id="active-filters-jobs" class="active-filters"></div>
                <div id="jobs-table"></div>
            </div>

            <div id="content-analytics" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-analytics-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (username, telegram_id –∏–ª–∏ id) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–ª–æ—É..." 
                           oninput="clearTimeout(analyticsSearchTimeout); analyticsSearchTimeout = setTimeout(() => loadUserAnalytics(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-analytics-campaign" onchange="loadAnalytics(); updateActiveFilters('analytics')" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div id="active-filters-analytics" class="active-filters"></div>
                <div id="analytics-content"></div>
                <div id="user-analytics-content" style="display: none;"></div>
            </div>

            <div id="content-logs" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="log-user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ user_id..." 
                           oninput="clearTimeout(logSearchTimeout); logSearchTimeout = setTimeout(() => loadLogs(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="log-table-filter" onchange="loadLogs(); updateActiveFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</option>
                    </select>
                    <select id="log-action-filter" onchange="loadLogs(); updateActiveFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
                        <option value="INSERT">–°–æ–∑–¥–∞–Ω–∏–µ (INSERT)</option>
                        <option value="UPDATE">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (UPDATE)</option>
                        <option value="DELETE">–£–¥–∞–ª–µ–Ω–∏–µ (DELETE)</option>
                    </select>
                    <select id="filter-logs-campaign" onchange="applyLogsFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                    </select>
                    <button onclick="clearAllLogs()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; white-space: nowrap;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏
                    </button>
                </div>
                <div id="active-filters-logs" class="active-filters"></div>
                <div id="logs-table"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π -->
    <div class="modal" id="editGenerationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
                <p id="edit-user-info"></p>
            </div>
            <div class="form-group">
                <label>–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:</label>
                <input type="number" id="edit-generations-input" min="0">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveGenerations()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('editGenerationsModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h2>
                <p id="delete-user-info"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('deleteUserModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <p id="history-user-info"></p>
            </div>
            <div id="history-content" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('historyModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤ -->
    <div class="modal" id="confirmDeleteLogsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –ª–æ–≥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteLogs()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                <button class="btn" onclick="closeModal('confirmDeleteLogsModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="toast-container"></div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 401 –æ—à–∏–±–æ–∫
        let isRefreshingAuth = false;
        let refreshQueue = [];

        // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è fetch —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ 401
        async function fetchWithAuth(url, options = {}) {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            const response = await fetch(url, options);
            
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (response.status === 401) {
                // –ï—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∂–¥–µ–º –µ–≥–æ
                if (isRefreshingAuth) {
                    return new Promise((resolve) => {
                        refreshQueue.push(() => {
                            resolve(fetchWithAuth(url, options));
                        });
                    });
                }
                
                isRefreshingAuth = true;
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    const refreshed = await refreshAuth();
                    
                    if (refreshed) {
                        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, –ø–æ–≤—Ç–æ—Ä—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                        const retryResponse = await fetch(url, options);
                        
                        // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                        refreshQueue.forEach(callback => callback());
                        refreshQueue = [];
                        isRefreshingAuth = false;
                        
                        return retryResponse;
                    } else {
                        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        refreshQueue.forEach(callback => callback());
                        refreshQueue = [];
                        isRefreshingAuth = false;
                        
                        showToast('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'warning', '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                        showAuthRequiredModal();
                        
                        return response;
                    }
                } catch (error) {
                    refreshQueue.forEach(callback => callback());
                    refreshQueue = [];
                    isRefreshingAuth = false;
                    
                    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                    showAuthRequiredModal();
                    
                    return response;
                }
            }
            
            return response;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function refreshAuth() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Telegram WebApp API
                if (window.Telegram?.WebApp?.initData) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram WebApp –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    const initData = window.Telegram.WebApp.initData;
                    
                    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ initData
                    const params = new URLSearchParams(initData);
                    const authData = {};
                    params.forEach((value, key) => {
                        authData[key] = value;
                    });
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    const response = await fetch('/api/auth/telegram', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(authData),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.authenticated) {
                            return true;
                        }
                    }
                }
                
                // –ï—Å–ª–∏ Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
                const checkResponse = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    if (checkData.authenticated) {
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error refreshing auth:', error);
                return false;
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthRequiredModal() {
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ª–æ–≥–∏–Ω–∞
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen && !loginScreen.classList.contains('hidden')) {
                return;
            }
            
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞
            if (document.getElementById('authRequiredModal')) {
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'authRequiredModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                        <p>–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.</p>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="reloadPage()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                        <button class="btn" onclick="closeAuthModal()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAuthModal() {
            const modal = document.getElementById('authRequiredModal');
            if (modal) {
                modal.remove();
            }
        }

        function reloadPage() {
            window.location.reload();
        }

        // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showToast(message, type = 'info', title = null) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const titlesDefault = {
                success: '–£—Å–ø–µ—à–Ω–æ',
                error: '–û—à–∏–±–∫–∞',
                warning: '–í–Ω–∏–º–∞–Ω–∏–µ',
                info: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titlesDefault[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
        }

        let currentTab = 'users';
        let currentPage = { users: 1, orders: 1, payments: 1, jobs: 1 };
        let currentData = {};
        let searchTimeout = null;
        let logSearchTimeout = null;
        let orderSearchTimeout = null;
        let paymentSearchTimeout = null;
        let jobSearchTimeout = null;
        let analyticsSearchTimeout = null;
        let isAuthenticated = false;
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π fetch, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const response = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.authenticated) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                showLoginScreen();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        function showLoginScreen() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            closeAuthModal();
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            initTelegramLogin();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        function showMainContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = `@${currentUser.username || currentUser.telegram_id}`;
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            closeAuthModal();
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            loadCampaigns();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π
        let campaignsList = [];
        async function loadCampaigns() {
            try {
                const response = await fetchWithAuth('/api/campaigns');
                campaignsList = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã –∫–∞–º–ø–∞–Ω–∏–π
                ['users', 'orders', 'payments', 'jobs', 'logs', 'analytics'].forEach(tab => {
                    const select = document.getElementById(`filter-${tab}-campaign`);
                    if (select) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        const currentValue = select.value;
                        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
                        select.innerHTML = '<option value="">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>';
                        campaignsList.forEach(campaign => {
                            const option = document.createElement('option');
                            option.value = campaign;
                            option.textContent = campaign;
                            select.appendChild(option);
                        });
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateActiveFilters(tab) {
            const container = document.getElementById(`active-filters-${tab}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const filters = [];
            
            // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const userSearch = document.getElementById(tab === 'users' ? 'search-users' : 
                                                       tab === 'orders' ? 'search-orders-user' :
                                                       tab === 'payments' ? 'search-payments-user' :
                                                       tab === 'jobs' ? 'search-jobs-user' :
                                                       tab === 'analytics' ? 'search-analytics-user' :
                                                       'log-user-search')?.value?.trim();
            if (userSearch) {
                filters.push({ type: 'user', label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', value: userSearch, clear: () => {
                    const input = document.getElementById(tab === 'users' ? 'search-users' : 
                                                          tab === 'orders' ? 'search-orders-user' :
                                                          tab === 'payments' ? 'search-payments-user' :
                                                          tab === 'jobs' ? 'search-jobs-user' :
                                                          tab === 'analytics' ? 'search-analytics-user' :
                                                          'log-user-search');
                    if (input) input.value = '';
                    if (tab === 'users') searchUsers();
                    else if (tab === 'orders') loadOrders();
                    else if (tab === 'payments') loadPayments();
                    else if (tab === 'jobs') loadJobs();
                    else if (tab === 'logs') loadLogs();
                    else if (tab === 'analytics') loadAnalytics();
                }});
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞–º–ø–∞–Ω–∏–∏
            const campaign = document.getElementById(`filter-${tab}-campaign`)?.value;
            if (campaign) {
                filters.push({ type: 'campaign', label: '–ö–∞–º–ø–∞–Ω–∏—è', value: campaign, clear: () => {
                    const select = document.getElementById(`filter-${tab}-campaign`);
                    if (select) select.value = '';
                    if (tab === 'users') applyUsersFilters();
                    else if (tab === 'orders') applyOrdersFilters();
                    else if (tab === 'payments') applyPaymentsFilters();
                    else if (tab === 'jobs') applyJobsFilters();
                    else if (tab === 'logs') applyLogsFilters();
                    else if (tab === 'analytics') loadAnalytics();
                }});
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ª–æ–≥–æ–≤
            if (tab === 'logs') {
                const tableFilter = document.getElementById('log-table-filter')?.value;
                if (tableFilter) {
                    filters.push({ type: 'table', label: '–¢–∞–±–ª–∏—Ü–∞', value: tableFilter, clear: () => {
                        const select = document.getElementById('log-table-filter');
                        if (select) select.value = '';
                        loadLogs();
                    }});
                }
                
                const actionFilter = document.getElementById('log-action-filter')?.value;
                if (actionFilter) {
                    filters.push({ type: 'action', label: '–î–µ–π—Å—Ç–≤–∏–µ', value: actionFilter, clear: () => {
                        const select = document.getElementById('log-action-filter');
                        if (select) select.value = '';
                        loadLogs();
                    }});
                }
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–≥–∏
            filters.forEach((filter, index) => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                const removeId = `filter-remove-${tab}-${index}`;
                tag.innerHTML = `
                    <span class="filter-label">${filter.label}:</span>
                    <span class="filter-value">${filter.value}</span>
                    <span class="filter-remove" id="${removeId}">√ó</span>
                `;
                container.appendChild(tag);
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
                document.getElementById(removeId).addEventListener('click', (e) => {
                    e.stopPropagation();
                    filter.clear();
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyUsersFilters() {
            updateActiveFilters('users');
            searchUsers();
        }

        function applyOrdersFilters() {
            updateActiveFilters('orders');
            loadOrders();
        }

        function applyPaymentsFilters() {
            updateActiveFilters('payments');
            loadPayments();
        }

        function applyJobsFilters() {
            updateActiveFilters('jobs');
            loadJobs();
        }

        function applyLogsFilters() {
            updateActiveFilters('logs');
            loadLogs();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Widget Login
        async function initTelegramLogin() {
            const container = document.getElementById('telegram-login-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º bot username —á–µ—Ä–µ–∑ API
                const response = await fetch('/api/bot-username');
                const data = await response.json();
                const botUsername = data.botUsername;
                
                if (!botUsername) {
                    container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞: Bot username –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>';
                    return;
                }
                
                container.innerHTML = '';
                const script = document.createElement('script');
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
                script.src = 'https://telegram.org/js/telegram-widget.js?22&t=' + Date.now();
                script.setAttribute('data-telegram-login', botUsername);
                script.setAttribute('data-size', 'large');
                script.setAttribute('data-userpic', 'false');
                script.setAttribute('data-request-access', 'write');
                // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ auth-url –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                script.setAttribute('data-auth-url', window.location.origin + '/api/auth/telegram?t=' + Date.now());
                script.setAttribute('data-onauth', 'onTelegramAuth(user)');
                script.async = true;
                container.appendChild(script);
            } catch (error) {
                container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞: ' + error.message + '</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        async function onTelegramAuth(user) {
            try {
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });

                const data = await response.json();
                if (data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                    closeAuthModal();
                    showMainContent();
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≤–∫–ª–∞–¥–∫–∞ "–ì–ª–∞–≤–Ω–∞—è")
                    loadSummaryCampaigns();
                    loadSummaryStats();
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
                    loadStats();
                    loadUsers();
                } else {
                    showToast(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞', 'error', '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
        }


        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                await fetch('/api/auth/logout', { method: 'POST' });
                
                // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                isAuthenticated = false;
                currentUser = null;
                
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Telegram Widget –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –µ–≥–æ
                const container = document.getElementById('telegram-login-container');
                if (container) {
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–≤–∫–ª—é—á–∞—è —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞)
                    container.innerHTML = '';
                }
                
                // –û—á–∏—â–∞–µ–º cookies (–µ—Å–ª–∏ –µ—Å—Ç—å)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // –û—á–∏—â–∞–µ–º localStorage –∏ sessionStorage (Telegram Widget –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö)
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                }
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
                setTimeout(() => {
                    showLoginScreen();
                }, 100);
            } catch (error) {
                console.error('Logout error:', error);
                // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const container = document.getElementById('telegram-login-container');
                if (container) {
                    container.innerHTML = '';
                }
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {}
                // –í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                setTimeout(() => {
                    showLoginScreen();
                }, 100);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetchWithAuth('/api/stats');
                const stats = await response.json();
                
                document.getElementById('stat-users').textContent = stats.total_users || 0;
                document.getElementById('stat-orders').textContent = stats.completed_orders || 0;
                document.getElementById('stat-revenue').textContent = `${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ`;
                document.getElementById('stat-generations').textContent = stats.total_generations || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞–º–ø–∞–Ω–∏–π
        async function loadSummaryCampaigns() {
            try {
                const response = await fetchWithAuth('/api/analytics/campaigns');
                const campaigns = await response.json();
                
                const select = document.getElementById('summary-campaign-filter');
                if (select && campaigns.length > 0) {
                    campaigns.forEach(campaign => {
                        const option = document.createElement('option');
                        option.value = campaign.campaign_name;
                        option.textContent = campaign.campaign_name || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏';
                        select.appendChild(option);
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    select.addEventListener('change', (e) => {
                        currentSummaryCampaign = e.target.value;
                        loadSummaryStats(currentSummaryCampaign);
                    });
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∞—Ç–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadSummaryStats(campaign = '') {
            const container = document.getElementById('summary-content');
            try {
                const url = campaign ? `/api/stats/summary?campaign=${encodeURIComponent(campaign)}` : '/api/stats/summary';
                const response = await fetchWithAuth(url);
                const data = await response.json();
                
                container.innerHTML = `
                    <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ "–û–±—â–∞—è" —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –¥–Ω—è–º -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                            <h3 style="margin: 0; font-size: 18px; color: #667eea;">üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="daily-range-btn active" data-range="7d" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 6px; transition: all 0.3s;">7 –¥–Ω–µ–π</button>
                                <button class="daily-range-btn" data-range="30d" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">30 –¥–Ω–µ–π</button>
                                <button class="daily-range-btn" data-range="all" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">–í—Å–µ –≤—Ä–µ–º—è</button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button class="daily-metric-btn active" data-metric="all" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 6px; transition: all 0.3s;">–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏</button>
                            <button class="daily-metric-btn" data-metric="users" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                            <button class="daily-metric-btn" data-metric="orders" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üì¶ –ó–∞–∫–∞–∑—ã</button>
                            <button class="daily-metric-btn" data-metric="generations" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
                            <button class="daily-metric-btn" data-metric="payments" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üí≥ –ü–ª–∞—Ç–µ–∂–∏</button>
                            <button class="daily-metric-btn" data-metric="revenue" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üí∞ –í—ã—Ä—É—á–∫–∞</button>
                        </div>
                        <div style="position: relative; height: 350px;">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤ -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h3 style="margin: 0; font-size: 18px; color: #667eea;">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤</h3>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="metric-btn active" data-metric="all" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 6px; transition: all 0.3s;">–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏</button>
                                <button class="metric-btn" data-metric="users" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                                <button class="metric-btn" data-metric="orders" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üì¶ –ó–∞–∫–∞–∑—ã</button>
                                <button class="metric-btn" data-metric="generations" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
                                <button class="metric-btn" data-metric="payments" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üí≥ –ü–ª–∞—Ç–µ–∂–∏</button>
                                <button class="metric-btn" data-metric="revenue" style="padding: 8px 16px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; border-radius: 6px; transition: all 0.3s;">üí∞ –í—ã—Ä—É—á–∫–∞</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 350px;">
                            <canvas id="summaryChart"></canvas>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –°–µ–≥–æ–¥–Ω—è -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #667eea;">üìÖ –°–µ–≥–æ–¥–Ω—è</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.today.users}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ó–∞–∫–∞–∑—ã</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.today.orders}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${data.today.generations}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ü–ª–∞—Ç–µ–∂–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.today.payments}</div>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <div style="font-size: 12px; color: #666;">–í—ã—Ä—É—á–∫–∞</div>
                                    <div style="font-size: 28px; font-weight: bold; color: #27ae60;">${data.today.revenue.toFixed(0)} ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: 3 –¥–Ω—è -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #667eea;">üìä 3 –¥–Ω—è</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.three_days.users}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ó–∞–∫–∞–∑—ã</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.three_days.orders}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${data.three_days.generations}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ü–ª–∞—Ç–µ–∂–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.three_days.payments}</div>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <div style="font-size: 12px; color: #666;">–í—ã—Ä—É—á–∫–∞</div>
                                    <div style="font-size: 28px; font-weight: bold; color: #27ae60;">${data.three_days.revenue.toFixed(0)} ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞: –ù–µ–¥–µ–ª—è -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #667eea;">üìà –ù–µ–¥–µ–ª—è</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.week.users}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ó–∞–∫–∞–∑—ã</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.week.orders}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${data.week.generations}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #666;">–ü–ª–∞—Ç–µ–∂–∏</div>
                                    <div style="font-size: 24px; font-weight: bold; color: #333;">${data.week.payments}</div>
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <div style="font-size: 12px; color: #666;">–í—ã—Ä—É—á–∫–∞</div>
                                    <div style="font-size: 28px; font-weight: bold; color: #27ae60;">${data.week.revenue.toFixed(0)} ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç–∏ -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #667eea;">üîÑ –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                                <div style="font-size: 28px; font-weight: bold; color: #333;">${data.retention.total_users}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">–ü–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                                <div style="font-size: 28px; font-weight: bold; color: #3498db;">${data.retention.paid_users}</div>
                                <div style="font-size: 12px; color: #999;">${((data.retention.paid_users / data.retention.total_users) * 100).toFixed(1)}% –æ—Ç –≤—Å–µ—Ö</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">–ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                                <div style="font-size: 28px; font-weight: bold; color: #e74c3c;">${data.retention.repeat_customers}</div>
                                <div style="font-size: 12px; color: #999;">${data.retention.repeat_rate}% –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç—å</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">–ê–∫—Ç–∏–≤–Ω—ã—Ö (7 –¥–Ω–µ–π)</div>
                                <div style="font-size: 28px; font-weight: bold; color: #27ae60;">${data.retention.active_7d}</div>
                                <div style="font-size: 12px; color: #999;">${((data.retention.active_7d / data.retention.total_users) * 100).toFixed(1)}% –æ—Ç –≤—Å–µ—Ö</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">–ê–∫—Ç–∏–≤–Ω—ã—Ö (30 –¥–Ω–µ–π)</div>
                                <div style="font-size: 28px; font-weight: bold; color: #f39c12;">${data.retention.active_30d}</div>
                                <div style="font-size: 12px; color: #999;">${((data.retention.active_30d / data.retention.total_users) * 100).toFixed(1)}% –æ—Ç –≤—Å–µ—Ö</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="font-size: 13px; color: #666;">
                                <strong>–ú–µ—Ç—Ä–∏–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç–∏:</strong><br>
                                ‚Ä¢ <strong>–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:</strong> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å–æ–≤–µ—Ä—à–∏–≤—à–∏–µ 2+ –ø–ª–∞—Ç–µ–∂–∞<br>
                                ‚Ä¢ <strong>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</strong> —Å–¥–µ–ª–∞–ª–∏ –∑–∞–∫–∞–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7/30 –¥–Ω–µ–π<br>
                                ‚Ä¢ <strong>–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç—å:</strong> –ø—Ä–æ—Ü–µ–Ω—Ç –ø–ª–∞—Ç—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–≤–µ—Ä—à–∏–≤—à–∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–∫—É–ø–∫—É
                            </div>
                        </div>
                    </div>
                `;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
                window.summaryData = data;
                
                // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
                setTimeout(() => {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É "–û–±—â–∞—è" —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                    drawDailyChart(currentDailyRange, currentDailyMetric);
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º—ã "–û–±—â–∞—è"
                    document.querySelectorAll('.daily-range-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const range = e.target.dataset.range;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω
                            currentDailyRange = range;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                            document.querySelectorAll('.daily-range-btn').forEach(b => {
                                b.style.background = 'white';
                                b.style.color = '#333';
                                b.style.border = '1px solid #ddd';
                                b.classList.remove('active');
                            });
                            e.target.style.background = '#667eea';
                            e.target.style.color = 'white';
                            e.target.style.border = '1px solid #667eea';
                            e.target.classList.add('active');
                            
                            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
                            drawDailyChart(currentDailyRange, currentDailyMetric);
                        });
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ—Ç—Ä–∏–∫ –¥–∏–∞–≥—Ä–∞–º–º—ã "–û–±—â–∞—è"
                    document.querySelectorAll('.daily-metric-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const metric = e.target.dataset.metric;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –º–µ—Ç—Ä–∏–∫—É
                            currentDailyMetric = metric;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                            document.querySelectorAll('.daily-metric-btn').forEach(b => {
                                b.style.background = 'white';
                                b.style.color = '#333';
                                b.style.border = '1px solid #ddd';
                                b.classList.remove('active');
                            });
                            e.target.style.background = '#667eea';
                            e.target.style.color = 'white';
                            e.target.style.border = '1px solid #667eea';
                            e.target.classList.add('active');
                            
                            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
                            drawDailyChart(currentDailyRange, currentDailyMetric);
                        });
                    });
                    
                    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
                    drawSummaryChart(data, 'all');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –º–µ—Ç—Ä–∏–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
                    document.querySelectorAll('.metric-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const metric = e.target.dataset.metric;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                            document.querySelectorAll('.metric-btn').forEach(b => {
                                b.style.background = 'white';
                                b.style.color = '#333';
                                b.style.border = '1px solid #ddd';
                                b.classList.remove('active');
                            });
                            e.target.style.background = '#667eea';
                            e.target.style.color = 'white';
                            e.target.style.border = '1px solid #667eea';
                            e.target.classList.add('active');
                            
                            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
                            drawSummaryChart(window.summaryData, metric);
                        });
                    });
                }, 100);
            } catch (error) {
                console.error('Error loading summary stats:', error);
                container.innerHTML = '<div style="color: #e74c3c; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`content-${tab}`).style.display = 'block';
            
            loadTabData(tab);
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏
            updateActiveFilters(tab);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏
        async function loadTabData(tab) {
            // –î–ª—è –≤–∫–ª–∞–¥–∫–∏ dashboard –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (tab === 'dashboard') {
                return;
            }
            
            let container;
            if (tab === 'analytics') {
                container = document.getElementById('analytics-content');
            } else if (tab === 'logs') {
                container = document.getElementById('logs-table');
            } else {
                container = document.getElementById(`${tab}-table`);
            }
            
            if (!container) {
                console.error(`Container not found for tab: ${tab}`);
                return;
            }
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                let response;
                
                switch(tab) {
                    case 'users':
                        response = await fetchWithAuth(`/api/users?page=${currentPage.users}&limit=50`);
                        const usersData = await response.json();
                        currentData.users = usersData;
                        renderUsers(usersData);
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'payments':
                        loadPayments();
                        break;
                    case 'jobs':
                        loadJobs();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                    case 'logs':
                        await loadLogTables();
                        loadLogs();
                        break;
                }
            } catch (error) {
                if (container) {
                    container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
                }
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = document.getElementById('search-users').value;
                loadUsers(search);
            }, 300);
        }

        async function loadUsers(search = '') {
            const container = document.getElementById('users-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const campaign = document.getElementById('filter-users-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.users.toString(),
                    limit: '50'
                });
                if (search) params.append('search', search);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/users?${params.toString()}`);
                const data = await response.json();
                currentData.users = data;
                renderUsers(data);
                updateActiveFilters('users');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadOrders() {
            const container = document.getElementById('orders-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const userSearch = document.getElementById('search-orders-user')?.value || '';
                const campaign = document.getElementById('filter-orders-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.orders.toString(),
                    limit: '50'
                });
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/orders?${params.toString()}`);
                const data = await response.json();
                currentData.orders = data;
                renderOrders(data);
                updateActiveFilters('orders');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadPayments() {
            const container = document.getElementById('payments-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const userSearch = document.getElementById('search-payments-user')?.value || '';
                const campaign = document.getElementById('filter-payments-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.payments.toString(),
                    limit: '50'
                });
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/payments?${params.toString()}`);
                const data = await response.json();
                currentData.payments = data;
                renderPayments(data);
                updateActiveFilters('payments');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadJobs() {
            const container = document.getElementById('jobs-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const userSearch = document.getElementById('search-jobs-user')?.value || '';
                const campaign = document.getElementById('filter-jobs-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.jobs.toString(),
                    limit: '50'
                });
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/did-jobs?${params.toString()}`);
                const data = await response.json();
                currentData.jobs = data;
                renderJobs(data);
                updateActiveFilters('jobs');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsers(data) {
            const container = document.getElementById('users-table');
            
            if (!data.users || data.users.length === 0) {
                container.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Telegram ID</th>
                                <th>Username</th>
                                <th>–ò–º—è</th>
                                <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
                                <th>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</th>
                                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.telegram_id}</td>
                        <td>@${user.username || '-'}</td>
                        <td>${user.first_name || '-'} ${user.last_name || ''}</td>
                        <td>${user.start_param || '-'}</td>
                        <td>${user.generations || 0}</td>
                        <td class="timestamp">${new Date(user.created_at).toLocaleString('ru-RU')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editGenerations(${user.id}, '${user.username || user.first_name || 'User'}', ${user.generations || 0})">–ò–∑–º–µ–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.username || user.first_name || 'User'}')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn btn-primary btn-sm" onclick="viewUserHistory(${user.id})">–ò—Å—Ç–æ—Ä–∏—è</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('users', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤
        function renderOrders(data) {
            const container = document.getElementById('orders-table');
            
            if (!data.orders || data.orders.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü—Ä–æ–º–ø—Ç</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.orders.forEach((order, index) => {
                const promptId = `prompt-${order.id}-${index}`;
                const promptText = order.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è';
                const isLongPrompt = promptText.length > 30;
                const shortPrompt = isLongPrompt ? promptText.substring(0, 30) + '...' : promptText;
                const imageUrl = order.original_file_path || '';
                const hasImage = imageUrl && (imageUrl.startsWith('http://') || imageUrl.startsWith('https://'));
                
                html += `
                    <tr>
                        <td><a href="#" onclick="viewOrderDetails('${order.id}')" class="link">${order.id.substring(0, 8)}...</a></td>
                        <td>@${order.username || order.telegram_id || '-'}</td>
                        <td>${hasImage ? `<a href="${imageUrl}" target="_blank" class="link" style="font-size: 11px;">üì∑ –û—Ç–∫—Ä—ã—Ç—å</a>` : '-'}</td>
                        <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                        <td>
                            <span id="${promptId}-short">${shortPrompt}</span>
                            ${isLongPrompt ? `
                                <span id="${promptId}-full" style="display: none;">${promptText}</span>
                                <button class="btn btn-primary btn-sm" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="togglePrompt('${promptId}')">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                            ` : ''}
                        </td>
                        <td class="timestamp">${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('orders', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
        function renderPayments(data) {
            const container = document.getElementById('payments-table');
            
            if (!data.payments || data.payments.length === 0) {
                container.innerHTML = '<div class="empty">–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>YooMoney ID</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.payments.forEach(payment => {
                html += `
                    <tr>
                        <td>${payment.id.substring(0, 8)}...</td>
                        <td>@${payment.username || payment.telegram_id || '-'}</td>
                        <td>${payment.amount} ‚ÇΩ</td>
                        <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                        <td>${payment.yoomoney_payment_id || '-'}</td>
                        <td class="timestamp">${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('payments', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞–Ω–∏–π
        function renderJobs(data) {
            const container = document.getElementById('jobs-table');
            
            if (!data.jobs || data.jobs.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–º–ø—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–û—à–∏–±–∫–∞</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.jobs.forEach((job, index) => {
                const promptId = `job-prompt-${job.id}-${index}`;
                const promptText = job.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è';
                const isLongPrompt = promptText.length > 30;
                const shortPrompt = isLongPrompt ? promptText.substring(0, 30) + '...' : promptText;
                
                html += `
                    <tr>
                        <td>${job.id.substring(0, 8)}...</td>
                        <td>@${job.username || job.telegram_id || '-'}</td>
                        <td>
                            <span id="${promptId}-short">${shortPrompt}</span>
                            ${isLongPrompt ? `
                                <span id="${promptId}-full" style="display: none;">${promptText}</span>
                                <button class="btn btn-primary btn-sm" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="togglePrompt('${promptId}')">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                            ` : ''}
                        </td>
                        <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                        <td>${job.result_url ? `<a href="${job.result_url}" target="_blank" class="link">–°–º–æ—Ç—Ä–µ—Ç—å</a>` : '-'}</td>
                        <td>${job.error_message ? `<span style="color: red;">${job.error_message.substring(0, 50)}...</span>` : '-'}</td>
                        <td class="timestamp">${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('jobs', data);
            }
            
            container.innerHTML = html;
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function renderPagination(tab, data) {
            const totalPages = Math.ceil(data.total / 50);
            return `
                <div class="pagination">
                    <button ${currentPage[tab] === 1 ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] - 1})">‚Äπ –ù–∞–∑–∞–¥</button>
                    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage[tab]} –∏–∑ ${totalPages} (–≤—Å–µ–≥–æ: ${data.total})</span>
                    <button ${currentPage[tab] >= totalPages ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] + 1})">–í–ø–µ—Ä—ë–¥ ‚Ä∫</button>
                </div>
            `;
        }

        function changePage(tab, page) {
            currentPage[tab] = page;
            loadTabData(tab);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusBadge(status) {
            const statusMap = {
                'completed': 'success',
                'succeeded': 'success',
                'success': 'success',
                'pending': 'pending',
                'processing': 'processing',
                'failed': 'failed',
                'running': 'processing',
                'canceled': 'failed',
                'cancelled': 'failed'
            };
            return statusMap[status?.toLowerCase()] || 'pending';
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
        let editingUserId = null;
        function editGenerations(userId, userName, currentGenerations) {
            editingUserId = userId;
            document.getElementById('edit-user-info').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName} (–¢–µ–∫—É—â–µ–µ: ${currentGenerations})`;
            document.getElementById('edit-generations-input').value = currentGenerations;
            document.getElementById('editGenerationsModal').classList.add('active');
        }

        async function saveGenerations() {
            const newValue = parseInt(document.getElementById('edit-generations-input').value);
            
            if (isNaN(newValue) || newValue < 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ', 'error', '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏');
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/users/${editingUserId}/generations`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ generations: newValue })
                });

                if (response.ok) {
                    closeModal('editGenerationsModal');
                    loadUsers();
                    loadStats();
                    showToast('–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let deletingUserId = null;
        function deleteUser(userId, userName) {
            deletingUserId = userId;
            document.getElementById('delete-user-info').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        async function confirmDeleteUser() {
            try {
                const response = await fetchWithAuth(`/api/users/${deletingUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeModal('deleteUserModal');
                    loadUsers();
                    loadStats();
                    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }));
                    showToast(errorData.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞
        function togglePrompt(promptId) {
            const shortEl = document.getElementById(`${promptId}-short`);
            const fullEl = document.getElementById(`${promptId}-full`);
            const button = event.target;
            
            if (shortEl && fullEl && button) {
                if (shortEl.style.display === 'none') {
                    shortEl.style.display = 'inline';
                    fullEl.style.display = 'none';
                    button.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
                } else {
                    shortEl.style.display = 'none';
                    fullEl.style.display = 'inline';
                    button.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function viewUserHistory(userId) {
            try {
                document.getElementById('historyModal').classList.add('active');
                const content = document.getElementById('history-content');
                content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const response = await fetchWithAuth(`/api/users/${userId}/history`);
                const history = await response.json();
                
                const user = history.user;
                document.getElementById('history-user-info').textContent = 
                    `@${user.username || user.telegram_id} | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(user.created_at).toLocaleString('ru-RU')} | –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${user.generations || 0}`;
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üì¶ –ó–∞–∫–∞–∑—ã (${history.orders.length})</h3>
                        ${history.orders.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.orders.map(order => `
                                            <tr>
                                                <td>${order.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                                                <td>${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üí≥ –ü–ª–∞—Ç–µ–∂–∏ (${history.payments.length})</h3>
                        ${history.payments.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–°—É–º–º–∞</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.payments.map(payment => `
                                            <tr>
                                                <td>${payment.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                                                <td>${payment.amount} ‚ÇΩ</td>
                                                <td>${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üé¨ –ó–∞–¥–∞–Ω–∏—è (${history.jobs.length})</h3>
                        ${history.jobs.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.jobs.map(job => `
                                            <tr>
                                                <td>${job.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                                                <td>${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</p>'}
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                document.getElementById('history-content').innerHTML = 
                    `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        async function loadAnalytics() {
            const userSearch = document.getElementById('search-analytics-user')?.value || '';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (userSearch) {
                await loadUserAnalytics(userSearch);
                return;
            }
            
            // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
            const container = document.getElementById('analytics-content');
            const userContainer = document.getElementById('user-analytics-content');
            
            container.style.display = 'block';
            userContainer.style.display = 'none';
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>';
            
            try {
                const campaign = document.getElementById('filter-analytics-campaign')?.value || '';
                const statsUrl = campaign ? `/api/stats?campaign=${encodeURIComponent(campaign)}` : '/api/stats';
                
                const [campaignsResponse, statsResponse] = await Promise.all([
                    fetchWithAuth('/api/analytics/campaigns'),
                    fetchWithAuth(statsUrl)
                ]);
                
                const campaigns = await campaignsResponse.json();
                const stats = await statsResponse.json();
                
                renderAnalytics(campaigns, stats);
                updateActiveFilters('analytics');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadUserAnalytics(userSearch = null) {
            const search = userSearch || document.getElementById('search-analytics-user')?.value || '';
            
            if (!search) {
                document.getElementById('analytics-content').style.display = 'block';
                document.getElementById('user-analytics-content').style.display = 'none';
                loadAnalytics();
                return;
            }

            const container = document.getElementById('analytics-content');
            const userContainer = document.getElementById('user-analytics-content');
            
            container.style.display = 'none';
            userContainer.style.display = 'block';
            userContainer.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>';

            try {
                // –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º user_id
                const userSearchResponse = await fetchWithAuth(`/api/users?search=${encodeURIComponent(search)}&limit=1`);
                const userSearchData = await userSearchResponse.json();
                
                if (!userSearchData.users || userSearchData.users.length === 0) {
                    userContainer.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                    return;
                }

                const userId = userSearchData.users[0].id;
                
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const analyticsResponse = await fetchWithAuth(`/api/analytics/user/${userId}`);
                const analytics = await analyticsResponse.json();
                
                renderUserAnalytics(analytics);
            } catch (error) {
                userContainer.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}</div>`;
            }
        }

        function renderUserAnalytics(data) {
            const container = document.getElementById('user-analytics-content');
            
            const flowSteps = [
                { name: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', passed: data.flow.registered, icon: '‚úÖ' },
                { name: '–°–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑ (–æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ)', passed: data.flow.has_orders, icon: data.flow.has_orders ? '‚úÖ' : '‚ùå' },
                { name: '–û–ø–ª–∞—Ç–∏–ª / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', passed: data.flow.has_payments, icon: data.flow.has_payments ? '‚úÖ' : '‚ùå' },
                { name: '–ó–∞–≤–µ—Ä—à–∏–ª –∑–∞–∫–∞–∑ (–ø–æ–ª—É—á–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)', passed: data.flow.has_completed, icon: data.flow.has_completed ? '‚úÖ' : '‚ùå' }
            ];
            
            const allPassed = flowSteps.every(step => step.passed);
            const completionRate = data.flow.completion_rate;

            let html = `
                <div style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 15px;">üë§ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                                <div style="font-size: 16px; font-weight: bold;">@${data.user.username || data.user.telegram_id || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 2px;">ID: ${data.user.id} | Telegram: ${data.user.telegram_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.user.generations || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                                <div style="font-size: 14px;">${new Date(data.user.created_at).toLocaleDateString('ru-RU')}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">üîÑ –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ñ–ª–æ—É</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold;">–°—Ç–∞—Ç—É—Å:</span>
                                <span style="font-size: 18px; font-weight: bold; color: ${allPassed ? '#28a745' : '#ffc107'};">
                                    ${allPassed ? '‚úÖ –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –ø—Ä–æ–π–¥–µ–Ω' : '‚ö†Ô∏è –§–ª–æ—É –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω'}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:</span>
                                <span style="font-size: 18px; font-weight: bold;">${completionRate}%</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${flowSteps.map(step => `
                                <div style="padding: 15px; background: ${step.passed ? '#d4edda' : '#f8d7da'}; border-radius: 6px; border-left: 4px solid ${step.passed ? '#28a745' : '#dc3545'};">
                                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">
                                        ${step.icon} ${step.name}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        ${step.passed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">üì¶ –ó–∞–∫–∞–∑—ã</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.orders.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.orders.completed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${data.orders.failed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${data.orders.pending}</div>
                            </div>
                        </div>
                        ${data.orders.generations_orders > 0 ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <div style="font-size: 12px; color: #666;">–ó–∞–∫–∞–∑—ã –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                                <div style="font-size: 18px; font-weight: bold;">${data.orders.generations_orders}</div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">üí≥ –ü–ª–∞—Ç–µ–∂–∏</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.payments.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.payments.successful}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–û–∂–∏–¥–∞—é—Ç</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${data.payments.pending}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${parseFloat(data.payments.total_spent).toFixed(2)} ‚ÇΩ</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.jobs.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.jobs.completed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${data.jobs.failed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</div>
                                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${data.jobs.processing}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function renderAnalytics(campaigns, stats) {
            const container = document.getElementById('analytics-content');
            
            let html = `
                <h2 style="margin-bottom: 20px;">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="analytics-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–í—ã—Ä—É—á–∫–∞</div>
                        <div style="font-size: 24px; font-weight: bold;">${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–£—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.successful_payments || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.completed_orders || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ü—Ä–æ–≤–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.failed_orders || 0}</div>
                    </div>
                </div>
                
                ${stats.flow ? `
                    <h2 style="margin-bottom: 20px; margin-top: 40px; font-size: ${window.innerWidth <= 768 ? '18px' : '20px'};">üîÑ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ñ–ª–æ—É</h2>
                    <div style="background: white; padding: ${window.innerWidth <= 768 ? '15px' : '30px'}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 40px;">
                        <p style="font-size: ${window.innerWidth <= 768 ? '11px' : '12px'}; color: #666; margin-bottom: 20px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ—à–ª–∏ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ñ–ª–æ—É: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ ‚Üí –æ–ø–ª–∞—Ç–∞/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 15px; max-width: 600px; margin: 0 auto;">
                            ${getFlowStepHtml('1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ', stats.flow.registered, stats.flow.registered, 100, '#667eea')}
                            ${getFlowStepHtml('2. –°–æ–∑–¥–∞–ª–∏ –∑–∞–∫–∞–∑ (–æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ñ–æ—Ç–æ)', stats.flow.created_order, stats.flow.registered, parseFloat(stats.flow.conversion_registered_to_order), '#48bb78', `‚Üì ${stats.flow.conversion_registered_to_order}%`)}
                            ${getFlowStepHtml('3. –û–ø–ª–∞—Ç–∏–ª–∏ / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', stats.flow.paid_or_used_generations, stats.flow.created_order, parseFloat(stats.flow.conversion_order_to_paid), '#ed8936', `‚Üì ${stats.flow.conversion_order_to_paid}%`)}
                            ${getFlowStepHtml('4. –ó–∞–≤–µ—Ä—à–∏–ª–∏ –∑–∞–∫–∞–∑ (–ø–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)', stats.flow.completed_order, stats.flow.paid_or_used_generations, parseFloat(stats.flow.conversion_paid_to_completed), '#38b2ac', `‚Üì ${stats.flow.conversion_paid_to_completed}%`)}
                        </div>
                        <div style="margin-top: 20px; padding: ${window.innerWidth <= 768 ? '10px' : '15px'}; background: #f8f9fa; border-radius: 6px; text-align: center;">
                            <div style="font-size: ${window.innerWidth <= 768 ? '11px' : '12px'}; color: #666; margin-bottom: 5px;">–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                            <div style="font-size: ${window.innerWidth <= 768 ? '20px' : '24px'}; font-weight: bold; color: #667eea;">${stats.flow.overall_conversion}%</div>
                            <div style="font-size: ${window.innerWidth <= 768 ? '10px' : '11px'}; color: #999; margin-top: 5px;">${stats.flow.completed_order} –∏–∑ ${stats.flow.registered} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∑–∞–∫–∞–∑</div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="analytics-charts" style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 40px;">
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px;">üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                            <div style="display: flex; gap: 5px;">
                                <button class="range-btn" data-range="3h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">3—á</button>
                                <button class="range-btn" data-range="24h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">24—á</button>
                                <button class="range-btn" data-range="7d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">7–¥</button>
                                <button class="range-btn active" data-range="30d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px;">30–¥</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Ä–æ—Å—Ç–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
                        </p>
                        <div style="position: relative; height: 300px;">
                            <canvas id="usersGrowthChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px;">üìä –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h3>
                            <div style="display: flex; gap: 5px;">
                                <button class="range-btn-campaigns" data-range="3h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">3—á</button>
                                <button class="range-btn-campaigns" data-range="24h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">24—á</button>
                                <button class="range-btn-campaigns" data-range="7d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">7–¥</button>
                                <button class="range-btn-campaigns active" data-range="30d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px;">30–¥</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Ä–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.
                        </p>
                        <div style="position: relative; height: 300px;">
                            <canvas id="campaignsGrowthChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px;">üí∞ –†–æ—Å—Ç –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                            <div style="display: flex; gap: 5px;">
                                <button class="range-btn-payments" data-range="3h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">3—á</button>
                                <button class="range-btn-payments" data-range="24h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">24—á</button>
                                <button class="range-btn-payments" data-range="7d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">7–¥</button>
                                <button class="range-btn-payments active" data-range="30d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px;">30–¥</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Ä–æ—Å—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –æ–±—â–µ–π —Å—É–º–º—ã –≤—ã—Ä—É—á–∫–∏.
                        </p>
                        <div style="position: relative; height: 300px;">
                            <canvas id="paymentsGrowthChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 16px;">üí∞ –†–æ—Å—Ç –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h3>
                            <div style="display: flex; gap: 5px;">
                                <button class="range-btn-payments-campaigns" data-range="3h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">3—á</button>
                                <button class="range-btn-payments-campaigns" data-range="24h" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">24—á</button>
                                <button class="range-btn-payments-campaigns" data-range="7d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px;">7–¥</button>
                                <button class="range-btn-payments-campaigns active" data-range="30d" style="padding: 5px 10px; font-size: 11px; cursor: pointer; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px;">30–¥</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Ä–æ—Å—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π.
                        </p>
                        <div style="position: relative; height: 300px;">
                            <canvas id="paymentsCampaignsGrowthChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 8px; font-size: 16px;">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–æ–≤</h3>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∑–∞–∫–∞–∑—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã.
                        </p>
                        <div style="position: relative; height: 250px;">
                            <canvas id="ordersChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 8px; font-size: 16px;">–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏–π</h3>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –≤–∏–¥–µ–æ –≤ RunwayML. –ö–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                        </p>
                        <div style="position: relative; height: 250px;">
                            <canvas id="jobsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; margin-top: 40px;">
                    <button id="campaigns-tab-active" class="tab-btn active" onclick="switchCampaignsTab('active')" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">üìà –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</button>
                    <button id="campaigns-tab-deleted" class="tab-btn" onclick="switchCampaignsTab('deleted')" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #333; border-radius: 4px; cursor: pointer; font-size: 14px;">üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</button>
                </div>
                
                <div id="campaigns-active-content">
                    <h2 style="margin-bottom: 20px;">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h2>
                ${campaigns.length > 0 ? `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚≠ê)</th>
                                    <th>–ó–∞–∫–∞–∑—ã</th>
                                    <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%)</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(c => {
                                    const campaignName = c.campaign_name || '';
                                    const safeCampaignName = campaignName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    return `
                                    <tr>
                                        <td>${campaignName || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏'}</td>
                                        <td>${c.total_users || 0}</td>
                                        <td>${parseFloat(c.total_payments_rub || 0).toFixed(2)}</td>
                                        <td>${c.total_payments_stars || 0}</td>
                                        <td>${c.completed_orders || 0}</td>
                                        <td>${parseFloat(c.conversion_rate || 0).toFixed(2)}%</td>
                                        <td class="actions">
                                            ${campaignName && campaignName !== '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏' ? `
                                                <button class="btn btn-danger btn-sm" onclick="resetCampaignStats('${safeCampaignName}')" style="margin-right: 5px;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteCampaign('${safeCampaignName}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                            ` : '<span style="color: #999;">-</span>'}
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${campaigns.length > 0 ? `
                        <div style="margin-top: 40px;">
                            <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin-bottom: 15px; font-size: 16px;">–í—ã—Ä—É—á–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h3>
                                <div style="position: relative; height: 350px;">
                                    <canvas id="campaignsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                ` : '<p style="color: #999;">–î–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º –Ω–µ—Ç</p>'}
                </div>
                
                <div id="campaigns-deleted-content" style="display: none;">
                    <h2 style="margin-bottom: 20px;">üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
                    <div id="deleted-campaigns-list">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π...</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º
            setTimeout(() => {
                drawOrdersChart(stats);
                drawJobsChart(stats);
                drawUsersGrowthChart(currentUsersRange);
                drawCampaignsGrowthChart(currentCampaignsRange);
                drawPaymentsGrowthChart(currentPaymentsRange);
                drawPaymentsCampaignsGrowthChart(currentPaymentsCampaignsRange);
                if (campaigns.length > 0) {
                    drawCampaignsChart(campaigns);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                document.querySelectorAll('.range-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const range = e.target.dataset.range;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        document.querySelectorAll('.range-btn').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#333';
                            b.style.border = '1px solid #ddd';
                            b.classList.remove('active');
                        });
                        e.target.style.background = '#667eea';
                        e.target.style.color = 'white';
                        e.target.style.border = '1px solid #667eea';
                        e.target.classList.add('active');
                        
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                        await drawUsersGrowthChart(range);
                    });
                });
                
                document.querySelectorAll('.range-btn-campaigns').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const range = e.target.dataset.range;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        document.querySelectorAll('.range-btn-campaigns').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#333';
                            b.style.border = '1px solid #ddd';
                            b.classList.remove('active');
                        });
                        e.target.style.background = '#667eea';
                        e.target.style.color = 'white';
                        e.target.style.border = '1px solid #667eea';
                        e.target.classList.add('active');
                        
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                        await drawCampaignsGrowthChart(range);
                    });
                });
                
                document.querySelectorAll('.range-btn-payments').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const range = e.target.dataset.range;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        document.querySelectorAll('.range-btn-payments').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#333';
                            b.style.border = '1px solid #ddd';
                            b.classList.remove('active');
                        });
                        e.target.style.background = '#667eea';
                        e.target.style.color = 'white';
                        e.target.style.border = '1px solid #667eea';
                        e.target.classList.add('active');
                        
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                        await drawPaymentsGrowthChart(range);
                    });
                });
                
                document.querySelectorAll('.range-btn-payments-campaigns').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const range = e.target.dataset.range;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        document.querySelectorAll('.range-btn-payments-campaigns').forEach(b => {
                            b.style.background = 'white';
                            b.style.color = '#333';
                            b.style.border = '1px solid #ddd';
                            b.classList.remove('active');
                        });
                        e.target.style.background = '#667eea';
                        e.target.style.color = 'white';
                        e.target.style.border = '1px solid #667eea';
                        e.target.classList.add('active');
                        
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                        await drawPaymentsCampaignsGrowthChart(range);
                    });
                });
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —à–∞–≥–∞ –≤–æ—Ä–æ–Ω–∫–∏
        function getFlowStepHtml(label, current, previous, percentage, color, conversionText = '') {
            const width = previous > 0 ? (current / previous * 100) : 0;
            const isMobile = window.innerWidth <= 768;
            return `
                <div style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 5px;">
                        <span style="font-weight: 600; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 200px;' : ''}">${label}</span>
                        <span style="font-size: ${isMobile ? '16px' : '18px'}; font-weight: bold; color: ${color};">${current}</span>
                    </div>
                    ${conversionText ? `
                        <div style="text-align: center; margin-bottom: 5px; font-size: ${isMobile ? '10px' : '11px'}; color: #999;">${conversionText}</div>
                    ` : ''}
                    <div style="height: ${isMobile ? '35px' : '40px'}; background: #e9ecef; border-radius: 6px; overflow: hidden; position: relative;">
                        <div style="height: 100%; width: ${width}%; background: linear-gradient(90deg, ${color} 0%, ${color}dd 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-weight: bold; font-size: ${isMobile ? '11px' : '12px'}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        let ordersChart = null;
        let jobsChart = null;
        let campaignsChart = null;
        let usersGrowthChart = null;
        let campaignsGrowthChart = null;
        let paymentsGrowthChart = null;
        let paymentsCampaignsGrowthChart = null;
        let summaryChart = null;
        
        let currentPaymentsRange = '30d';
        let currentPaymentsCampaignsRange = '30d';
        let currentSummaryCampaign = '';
        let currentDailyRange = '7d';
        let currentDailyMetric = 'all';
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞ —Å—Ç—Ä–æ–∫–∏
        function getCampaignColor(campaignName) {
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º null, undefined, –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É)
            const normalizedName = campaignName || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏';
            
            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
            const colors = [
                'rgba(75, 192, 192, 1)',    // teal
                'rgba(255, 99, 132, 1)',    // red
                'rgba(54, 162, 235, 1)',    // blue
                'rgba(255, 206, 86, 1)',    // yellow
                'rgba(153, 102, 255, 1)',   // purple
                'rgba(255, 159, 64, 1)',    // orange
                'rgba(46, 204, 113, 1)',    // green
                'rgba(52, 152, 219, 1)',    // ocean blue
                'rgba(231, 76, 60, 1)',     // crimson
                'rgba(155, 89, 182, 1)',    // amethyst
                'rgba(241, 196, 15, 1)',    // sunflower
                'rgba(26, 188, 156, 1)',    // turquoise
                'rgba(230, 126, 34, 1)',    // carrot
                'rgba(149, 165, 166, 1)',   // concrete
                'rgba(243, 156, 18, 1)',    // orange peel
                'rgba(192, 57, 43, 1)',     // pomegranate
                'rgba(142, 68, 173, 1)',    // wisteria
                'rgba(41, 128, 185, 1)',    // belize hole
                'rgba(39, 174, 96, 1)',     // nephritis
                'rgba(211, 84, 0, 1)',      // pumpkin
                'rgba(44, 62, 80, 1)',      // midnight blue
                'rgba(127, 140, 141, 1)',   // asbestos
                'rgba(22, 160, 133, 1)',    // green sea
                'rgba(189, 195, 199, 1)',   // silver
                'rgba(236, 240, 241, 1)'    // clouds
            ];
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (djb2 —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–µ–π)
            let hash = 5381;
            const str = normalizedName.toLowerCase();
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) + hash) + str.charCodeAt(i);
                hash = hash & 0x7fffffff; // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–º—É 32-–±–∏—Ç–Ω–æ–º—É —á–∏—Å–ª—É
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –±–æ–ª—å—à–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
            hash = (hash + str.length * 31) & 0x7fffffff;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ö–µ—à–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
            const index = hash % colors.length;
            return colors[index];
        }

        // –î–∏–∞–≥—Ä–∞–º–º–∞ "–û–±—â–∞—è" - –ø–æ –¥–Ω—è–º
        let dailyChart = null;
        async function drawDailyChart(range = '7d', metric = 'all') {
            const canvas = document.getElementById('dailyChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            try {
                const campaign = currentSummaryCampaign || '';
                const url = campaign 
                    ? `/api/stats/summary-daily?range=${range}&campaign=${encodeURIComponent(campaign)}`
                    : `/api/stats/summary-daily?range=${range}`;
                const response = await fetchWithAuth(url);
                const result = await response.json();
                
                const labels = result.data.map(row => {
                    const date = new Date(row.date);
                    return `${date.getDate()}.${date.getMonth() + 1}`;
                });
                
                let datasets = [];
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
                if (metric === 'all') {
                    datasets = [
                        {
                            label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                            data: result.data.map(row => parseInt(row.new_users)),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '–ó–∞–∫–∞–∑—ã',
                            data: result.data.map(row => parseInt(row.new_orders)),
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏',
                            data: result.data.map(row => parseInt(row.new_generations)),
                            backgroundColor: 'rgba(155, 89, 182, 0.2)',
                            borderColor: 'rgba(155, 89, 182, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '–ü–ª–∞—Ç–µ–∂–∏',
                            data: result.data.map(row => parseInt(row.new_payments)),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ];
                } else if (metric === 'users') {
                    datasets = [{
                        label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                        data: result.data.map(row => parseInt(row.new_users)),
                        backgroundColor: 'rgba(54, 162, 235, 0.3)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }];
                } else if (metric === 'orders') {
                    datasets = [{
                        label: '–ó–∞–∫–∞–∑—ã',
                        data: result.data.map(row => parseInt(row.new_orders)),
                        backgroundColor: 'rgba(255, 206, 86, 0.3)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }];
                } else if (metric === 'generations') {
                    datasets = [{
                        label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏',
                        data: result.data.map(row => parseInt(row.new_generations)),
                        backgroundColor: 'rgba(155, 89, 182, 0.3)',
                        borderColor: 'rgba(155, 89, 182, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }];
                } else if (metric === 'payments') {
                    datasets = [{
                        label: '–ü–ª–∞—Ç–µ–∂–∏',
                        data: result.data.map(row => parseInt(row.new_payments)),
                        backgroundColor: 'rgba(75, 192, 192, 0.3)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }];
                } else if (metric === 'revenue') {
                    datasets = [{
                        label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                        data: result.data.map(row => parseFloat(row.revenue)),
                        backgroundColor: 'rgba(39, 174, 96, 0.3)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }];
                }
                
                dailyChart = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: metric === 'all',
                                position: 'top'
                            },
                            title: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error drawing daily chart:', error);
            }
        }
        
        function drawSummaryChart(data, metric = 'all') {
            const canvas = document.getElementById('summaryChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (summaryChart) {
                summaryChart.destroy();
            }
            
            const labels = ['–°–µ–≥–æ–¥–Ω—è', '3 –¥–Ω—è', '–ù–µ–¥–µ–ª—è'];
            let datasets = [];
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
            if (metric === 'all') {
                // –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏
                datasets = [
                    {
                        label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                        data: [data.today.users, data.three_days.users, data.week.users],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '–ó–∞–∫–∞–∑—ã',
                        data: [data.today.orders, data.three_days.orders, data.week.orders],
                        backgroundColor: 'rgba(255, 206, 86, 0.6)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏',
                        data: [data.today.generations, data.three_days.generations, data.week.generations],
                        backgroundColor: 'rgba(155, 89, 182, 0.6)',
                        borderColor: 'rgba(155, 89, 182, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '–ü–ª–∞—Ç–µ–∂–∏',
                        data: [data.today.payments, data.three_days.payments, data.week.payments],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }
                ];
            } else if (metric === 'users') {
                datasets = [{
                    label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                    data: [data.today.users, data.three_days.users, data.week.users],
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }];
            } else if (metric === 'orders') {
                datasets = [{
                    label: '–ó–∞–∫–∞–∑—ã',
                    data: [data.today.orders, data.three_days.orders, data.week.orders],
                    backgroundColor: 'rgba(255, 206, 86, 0.7)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 2
                }];
            } else if (metric === 'generations') {
                datasets = [{
                    label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏',
                    data: [data.today.generations, data.three_days.generations, data.week.generations],
                    backgroundColor: 'rgba(155, 89, 182, 0.7)',
                    borderColor: 'rgba(155, 89, 182, 1)',
                    borderWidth: 2
                }];
            } else if (metric === 'payments') {
                datasets = [{
                    label: '–ü–ª–∞—Ç–µ–∂–∏',
                    data: [data.today.payments, data.three_days.payments, data.week.payments],
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2
                }];
            } else if (metric === 'revenue') {
                datasets = [{
                    label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                    data: [data.today.revenue, data.three_days.revenue, data.week.revenue],
                    backgroundColor: 'rgba(39, 174, 96, 0.7)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 2
                }];
            }
            
            summaryChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: metric === 'all',
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (metric === 'revenue') {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} ‚ÇΩ`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metric === 'revenue' ? '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)' : '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (metric === 'revenue') {
                                        return value.toFixed(0) + ' ‚ÇΩ';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawOrdersChart(stats) {
            const canvas = document.getElementById('ordersChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (ordersChart) {
                ordersChart.destroy();
            }
            
            const completed = stats.completed_orders || 0;
            const failed = stats.failed_orders || 0;
            
            ordersChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['–ó–∞–≤–µ—Ä—à–µ–Ω–æ', '–ü—Ä–æ–≤–∞–ª–µ–Ω–æ'],
                    datasets: [{
                        data: [completed, failed],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawJobsChart(stats) {
            const canvas = document.getElementById('jobsChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (jobsChart) {
                jobsChart.destroy();
            }
            
            const completed = stats.completed_jobs || 0;
            const failed = stats.failed_jobs || 0;
            
            jobsChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['–ó–∞–≤–µ—Ä—à–µ–Ω–æ', '–ü—Ä–æ–≤–∞–ª–µ–Ω–æ'],
                    datasets: [{
                        data: [completed, failed],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        let currentUsersRange = '30d';
        let currentCampaignsRange = '30d';

        async function drawUsersGrowthChart(range = '30d') {
            const canvas = document.getElementById('usersGrowthChart');
            if (!canvas) return;
            
            currentUsersRange = range;
            
            try {
                const response = await fetch(`/api/analytics/users-growth?range=${range}`);
                const result = await response.json();
                const data = result.data;
                const format = result.format;
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (usersGrowthChart) {
                    usersGrowthChart.destroy();
                }
                
                const labels = data.map(d => {
                    const date = new Date(d.date);
                    if (format === 'datetime') {
                        return date.toLocaleString('ru-RU', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                const newUsers = data.map(d => parseInt(d.new_users));
                const totalUsers = data.map(d => parseInt(d.total_users));
                
                usersGrowthChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                                data: newUsers,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
                                data: totalUsers,
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: window.innerWidth <= 768 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏'
                                },
                                beginAtZero: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
                                },
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error drawing users growth chart:', error);
            }
        }

        async function drawCampaignsGrowthChart(range = '30d') {
            const canvas = document.getElementById('campaignsGrowthChart');
            if (!canvas) return;
            
            currentCampaignsRange = range;
            
            try {
                const response = await fetch(`/api/analytics/users-growth-by-campaign?range=${range}`);
                const result = await response.json();
                const data = result.data;
                const format = result.format;
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (campaignsGrowthChart) {
                    campaignsGrowthChart.destroy();
                }
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º
                const campaignData = {};
                data.forEach(d => {
                    if (!campaignData[d.campaign]) {
                        campaignData[d.campaign] = {
                            dates: [],
                            users: []
                        };
                    }
                    campaignData[d.campaign].dates.push(d.date);
                    campaignData[d.campaign].users.push(parseInt(d.total_users));
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã
                const allDates = [...new Set(data.map(d => d.date))].sort();
                const labels = allDates.map(date => {
                    const d = new Date(date);
                    if (format === 'datetime') {
                        return d.toLocaleString('ru-RU', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                
                const datasets = Object.keys(campaignData).map((campaign) => {
                    const color = getCampaignColor(campaign);
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç
                    const userData = allDates.map(date => {
                        const dateIndex = campaignData[campaign].dates.indexOf(date);
                        return dateIndex >= 0 ? campaignData[campaign].users[dateIndex] : null;
                    });
                    
                    return {
                        label: campaign,
                        data: userData,
                        borderColor: color,
                        backgroundColor: color.replace('1)', '0.1)'),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        spanGaps: true
                    };
                });
                
                campaignsGrowthChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: window.innerWidth <= 768 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error drawing campaigns growth chart:', error);
            }
        }

        async function drawPaymentsGrowthChart(range = '30d') {
            const canvas = document.getElementById('paymentsGrowthChart');
            if (!canvas) return;
            
            currentPaymentsRange = range;
            
            try {
                const response = await fetch(`/api/analytics/payments-growth?range=${range}`);
                const result = await response.json();
                const data = result.data;
                const format = result.format;
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (paymentsGrowthChart) {
                    paymentsGrowthChart.destroy();
                }
                
                const labels = data.map(d => {
                    const date = new Date(d.date);
                    if (format === 'datetime') {
                        return date.toLocaleString('ru-RU', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                const newPayments = data.map(d => parseInt(d.new_payments));
                const totalAmount = data.map(d => parseFloat(d.total_amount));
                
                paymentsGrowthChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '–ù–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏',
                                data: newPayments,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: '–°—É–º–º–∞ (‚ÇΩ)',
                                data: totalAmount,
                                borderColor: 'rgba(153, 102, 255, 1)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: window.innerWidth <= 768 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 1) {
                                            return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} ‚ÇΩ`;
                                        }
                                        return `${context.dataset.label}: ${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π'
                                },
                                beginAtZero: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '–°—É–º–º–∞ (‚ÇΩ)'
                                },
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error drawing payments growth chart:', error);
            }
        }

        async function drawPaymentsCampaignsGrowthChart(range = '30d') {
            const canvas = document.getElementById('paymentsCampaignsGrowthChart');
            if (!canvas) return;
            
            currentPaymentsCampaignsRange = range;
            
            try {
                const response = await fetch(`/api/analytics/payments-growth-by-campaign?range=${range}`);
                const result = await response.json();
                const data = result.data;
                const format = result.format;
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (paymentsCampaignsGrowthChart) {
                    paymentsCampaignsGrowthChart.destroy();
                }
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º
                const campaignData = {};
                data.forEach(d => {
                    if (!campaignData[d.campaign]) {
                        campaignData[d.campaign] = {
                            dates: [],
                            amounts: []
                        };
                    }
                    campaignData[d.campaign].dates.push(d.date);
                    campaignData[d.campaign].amounts.push(parseFloat(d.total_amount));
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã
                const allDates = [...new Set(data.map(d => d.date))].sort();
                const labels = allDates.map(date => {
                    const d = new Date(date);
                    if (format === 'datetime') {
                        return d.toLocaleString('ru-RU', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                
                const datasets = Object.keys(campaignData).map((campaign) => {
                    const color = getCampaignColor(campaign);
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç
                    const amountData = allDates.map(date => {
                        const dateIndex = campaignData[campaign].dates.indexOf(date);
                        return dateIndex >= 0 ? campaignData[campaign].amounts[dateIndex] : null;
                    });
                    
                    return {
                        label: campaign,
                        data: amountData,
                        borderColor: color,
                        backgroundColor: color.replace('1)', '0.1)'),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        spanGaps: true
                    };
                });
                
                paymentsCampaignsGrowthChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: window.innerWidth <= 768 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y ? context.parsed.y.toFixed(2) : 0} ‚ÇΩ`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '–°—É–º–º–∞ (‚ÇΩ)'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error drawing payments campaigns growth chart:', error);
            }
        }

        function drawCampaignsChart(campaigns) {
            const canvas = document.getElementById('campaignsChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (campaignsChart) {
                campaignsChart.destroy();
            }
            
            const labels = campaigns.map(c => c.campaign_name || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏');
            const revenues = campaigns.map(c => parseFloat(c.total_payments_rub || 0));
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
            const backgroundColors = labels.map(label => {
                const color = getCampaignColor(label);
                return color.replace('1)', '0.8)');
            });
            const borderColors = labels.map(label => getCampaignColor(label));
            
            campaignsChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                        data: revenues,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `–í—ã—Ä—É—á–∫–∞: ${context.parsed.y.toFixed(2)} ‚ÇΩ`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ‚ÇΩ';
                                },
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: window.innerWidth <= 768 ? 90 : 45,
                                minRotation: window.innerWidth <= 768 ? 90 : 45,
                                font: {
                                    size: window.innerWidth <= 768 ? 9 : 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
        async function loadLogTables() {
            try {
                const response = await fetchWithAuth('/api/logs/tables');
                const tables = await response.json();
                
                const select = document.getElementById('log-table-filter');
                if (select) {
                    // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
                    select.innerHTML = '<option value="">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</option>';
                    tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading log tables:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
        async function loadLogs(page = 1) {
            const container = document.getElementById('logs-table');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>';

            try {
                const tableFilter = document.getElementById('log-table-filter')?.value || '';
                const actionFilter = document.getElementById('log-action-filter')?.value || '';
                const userSearch = document.getElementById('log-user-search')?.value || '';
                const campaign = document.getElementById('filter-logs-campaign')?.value || '';
                
                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '100'
                });
                if (tableFilter) params.append('table', tableFilter);
                if (actionFilter) params.append('action', actionFilter);
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/logs?${params.toString()}`);
                const data = await response.json();
                renderLogs(data);
                updateActiveFilters('logs');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ${error.message}</div>`;
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤
        function clearAllLogs() {
            document.getElementById('confirmDeleteLogsModal').classList.add('active');
        }

        // –£–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)
        async function deleteCampaign(campaignName) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é "${campaignName}"?\n\n–ö–∞–º–ø–∞–Ω–∏—è –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç–∞ –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ. –í—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—ë –ø–æ–∑–∂–µ.`)) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/campaigns/${encodeURIComponent(campaignName)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('–ö–∞–º–ø–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
                    loadAnalytics();
                    loadCampaigns();
                } else {
                    const error = await response.json();
                    showToast(error.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é
        async function restoreCampaign(campaignName) {
            try {
                const response = await fetchWithAuth(`/api/campaigns/${encodeURIComponent(campaignName)}/restore`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('–ö–∞–º–ø–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                    loadDeletedCampaigns();
                    loadAnalytics();
                    loadCampaigns();
                } else {
                    const error = await response.json();
                    showToast(error.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π
        function switchCampaignsTab(tab) {
            const activeTab = document.getElementById('campaigns-tab-active');
            const deletedTab = document.getElementById('campaigns-tab-deleted');
            const activeContent = document.getElementById('campaigns-active-content');
            const deletedContent = document.getElementById('campaigns-deleted-content');

            if (tab === 'active') {
                activeTab.classList.add('active');
                activeTab.style.background = '#667eea';
                activeTab.style.color = 'white';
                activeTab.style.border = 'none';
                deletedTab.classList.remove('active');
                deletedTab.style.background = 'white';
                deletedTab.style.color = '#333';
                deletedTab.style.border = '1px solid #ddd';
                activeContent.style.display = 'block';
                deletedContent.style.display = 'none';
            } else {
                deletedTab.classList.add('active');
                deletedTab.style.background = '#667eea';
                deletedTab.style.color = 'white';
                deletedTab.style.border = 'none';
                activeTab.classList.remove('active');
                activeTab.style.background = 'white';
                activeTab.style.color = '#333';
                activeTab.style.border = '1px solid #ddd';
                activeContent.style.display = 'none';
                deletedContent.style.display = 'block';
                loadDeletedCampaigns();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏
        async function loadDeletedCampaigns() {
            const container = document.getElementById('deleted-campaigns-list');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π...</div>';

            try {
                const response = await fetchWithAuth('/api/campaigns/deleted');
                const campaigns = await response.json();

                if (campaigns.length === 0) {
                    container.innerHTML = '<p style="color: #999;">–£–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –Ω–µ—Ç</p>';
                    return;
                }

                let html = `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
                                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(c => {
                                    const campaignName = c.campaign_name || '';
                                    const safeCampaignName = campaignName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    const createdDate = new Date(c.created_at).toLocaleDateString('ru-RU');
                                    return `
                                    <tr>
                                        <td>${campaignName || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏'}</td>
                                        <td>${c.description || '-'}</td>
                                        <td>${c.total_users || 0}</td>
                                        <td>${parseFloat(c.total_payments_rub || 0).toFixed(2)}</td>
                                        <td>${createdDate}</td>
                                        <td class="actions">
                                            ${campaignName && campaignName !== '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏' ? `
                                                <button class="btn btn-success btn-sm" onclick="restoreCampaign('${safeCampaignName}')">‚Ü©Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                            ` : '<span style="color: #999;">-</span>'}
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π: ${error.message}</div>`;
            }
        }

        // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–º–ø–∞–Ω–∏–∏
        async function resetCampaignStats(campaignName) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–º–ø–∞–Ω–∏–∏ "${campaignName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–º–ø–∞–Ω–∏–∏, –Ω–æ —Å–∞–º–∞ –∫–∞–º–ø–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/campaigns/${encodeURIComponent(campaignName)}/reset`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞', 'success');
                    loadAnalytics();
                } else {
                    const error = await response.json();
                    showToast(error.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        async function confirmDeleteLogs() {
            try {
                const response = await fetchWithAuth('/api/logs', {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showToast(error.error || error.details || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞', 'error');
                    closeModal('confirmDeleteLogsModal');
                    return;
                }
                
                const result = await response.json();
                showToast(`–£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.deletedCount || 0}`, 'success', result.message || '–õ–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã');
                
                closeModal('confirmDeleteLogsModal');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
                loadLogs(1);
            } catch (error) {
                console.error('Error clearing logs:', error);
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ª–æ–≥–æ–≤');
                closeModal('confirmDeleteLogsModal');
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
        function renderLogs(data) {
            const container = document.getElementById('logs-table');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            if (data.message) {
                container.innerHTML = `
                    <div class="empty" style="padding: 40px; text-align: center;">
                        <p style="margin-bottom: 15px; font-size: 16px; color: #856404;">‚ö†Ô∏è ${data.message}</p>
                        <p style="color: #666; font-size: 14px;">
                            –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:<br>
                            <code style="background: #f8f9fa; padding: 5px 10px; border-radius: 4px; margin-top: 10px; display: inline-block;">
                                docker compose exec app npm run migrate
                            </code>
                        </p>
                    </div>
                `;
                return;
            }
            
            if (!data.logs || data.logs.length === 0) {
                container.innerHTML = '<div class="empty">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–¢–∞–±–ª–∏—Ü–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th>ID –∑–∞–ø–∏—Å–∏</th>
                                <th>–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è</th>
                                <th>–î–∞–Ω–Ω—ã–µ</th>
                                <th>–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.logs.forEach((log, index) => {
                const actionColors = {
                    'INSERT': 'success',
                    'UPDATE': 'pending',
                    'DELETE': 'failed'
                };
                const actionLabels = {
                    'INSERT': '–°–æ–∑–¥–∞–Ω–∏–µ',
                    'UPDATE': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
                    'DELETE': '–£–¥–∞–ª–µ–Ω–∏–µ'
                };
                const actionColor = actionColors[log.action] || 'pending';
                const changedFields = log.changed_fields ? log.changed_fields.join(', ') : '-';
                const dataId = `log-data-${log.id}-${index}`;
                const hasOldData = log.old_data && Object.keys(log.old_data).length > 0;
                const hasNewData = log.new_data && Object.keys(log.new_data).length > 0;
                const userDisplay = log.username ? `@${log.username}` : (log.telegram_id ? `ID: ${log.telegram_id}` : (log.user_id ? `User ID: ${log.user_id}` : '-'));
                
                html += `
                    <tr>
                        <td>${log.id}</td>
                        <td>${userDisplay}</td>
                        <td><strong>${log.table_name}</strong></td>
                        <td><span class="badge ${actionColor}">${actionLabels[log.action] || log.action}</span></td>
                        <td style="font-family: monospace; font-size: 11px;">${log.record_id}</td>
                        <td style="font-size: 11px;">${changedFields}</td>
                        <td>
                            ${hasOldData || hasNewData ? `
                                <button class="btn btn-primary btn-sm" style="padding: 2px 6px; font-size: 10px;" onclick="toggleLogData('${dataId}')">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                                </button>
                                <div id="${dataId}" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                    ${hasOldData ? `<div style="margin-bottom: 10px;"><strong>–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong><pre style="margin-top: 5px; font-size: 10px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(log.old_data, null, 2)}</pre></div>` : ''}
                                    ${hasNewData ? `<div><strong>–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong><pre style="margin-top: 5px; font-size: 10px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(log.new_data, null, 2)}</pre></div>` : ''}
                                </div>
                            ` : '-'}
                        </td>
                        <td class="timestamp">${new Date(log.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 100) {
                const totalPages = Math.ceil(data.total / 100);
                html += `
                    <div class="pagination">
                        <button onclick="loadLogs(${Math.max(1, data.page - 1)})" ${data.page === 1 ? 'disabled' : ''}>–ù–∞–∑–∞–¥</button>
                        <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.page} –∏–∑ ${totalPages} (–í—Å–µ–≥–æ: ${data.total})</span>
                        <button onclick="loadLogs(${Math.min(totalPages, data.page + 1)})" ${data.page === totalPages ? 'disabled' : ''}>–í–ø–µ—Ä–µ–¥</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ª–æ–≥–∞
        function toggleLogData(dataId) {
            const element = document.getElementById(dataId);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkAuth();
        loadSummaryCampaigns();
        loadSummaryStats();
    </script>
</body>
</html>

