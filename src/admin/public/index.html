<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header .stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: #d4edda; color: #155724; }
        .badge.pending { background: #fff3cd; color: #856404; }
        .badge.failed { background: #f8d7da; color: #721c24; }
        .badge.processing { background: #d1ecf1; color: #0c5460; }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .link {
            color: #667eea;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-card h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .telegram-login-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .telegram-login-button:hover {
            background: #006ba3;
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h2>
            <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <div id="telegram-login-container"></div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">–ò–ª–∏ –≤–æ–π–¥–∏—Ç–µ –ø–æ username (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤):</p>
                <input type="text" id="manual-username" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram username" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 10px;">
                <button class="telegram-login-button" onclick="manualLogin()">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="mainContent" class="hidden">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                <div class="value" id="stat-users">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ó–∞–∫–∞–∑—ã</div>
                <div class="value" id="stat-orders">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–í—ã—Ä—É—á–∫–∞</div>
                <div class="value" id="stat-revenue">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <div class="value" id="stat-generations">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab" onclick="switchTab('orders')">üì¶ –ó–∞–∫–∞–∑—ã</button>
            <button class="tab" onclick="switchTab('payments')">üí≥ –ü–ª–∞—Ç–µ–∂–∏</button>
            <button class="tab" onclick="switchTab('jobs')">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
        </div>

        <div class="content">
            <div id="content-users" class="tab-content">
                <div class="search-box">
                    <input type="text" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, –∏–º–µ–Ω–∏ –∏–ª–∏ telegram_id..." oninput="searchUsers()">
                </div>
                <div id="users-table"></div>
            </div>

            <div id="content-orders" class="tab-content" style="display: none;">
                <div id="orders-table"></div>
            </div>

            <div id="content-payments" class="tab-content" style="display: none;">
                <div id="payments-table"></div>
            </div>

            <div id="content-jobs" class="tab-content" style="display: none;">
                <div id="jobs-table"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π -->
    <div class="modal" id="editGenerationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
                <p id="edit-user-info"></p>
            </div>
            <div class="form-group">
                <label>–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:</label>
                <input type="number" id="edit-generations-input" min="0">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveGenerations()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('editGenerationsModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h2>
                <p id="delete-user-info"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('deleteUserModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'users';
        let currentPage = { users: 1, orders: 1, payments: 1, jobs: 1 };
        let currentData = {};
        let searchTimeout = null;
        let isAuthenticated = false;
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check');
                const data = await response.json();
                if (data.authenticated) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                showLoginScreen();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            initTelegramLogin();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        function showMainContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = `@${currentUser.username || currentUser.telegram_id}`;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Widget Login
        async function initTelegramLogin() {
            const container = document.getElementById('telegram-login-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º bot username —á–µ—Ä–µ–∑ API
                const response = await fetch('/api/bot-username');
                const data = await response.json();
                const botUsername = data.botUsername;
                
                if (!botUsername) {
                    container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞: Bot username –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>';
                    return;
                }
                
                container.innerHTML = '';
                const script = document.createElement('script');
                script.src = 'https://telegram.org/js/telegram-widget.js?22';
                script.setAttribute('data-telegram-login', botUsername);
                script.setAttribute('data-size', 'large');
                script.setAttribute('data-userpic', 'false');
                script.setAttribute('data-request-access', 'write');
                script.setAttribute('data-auth-url', window.location.origin + '/api/auth/telegram');
                script.setAttribute('data-onauth', 'onTelegramAuth(user)');
                script.async = true;
                container.appendChild(script);
            } catch (error) {
                container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞: ' + error.message + '</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        async function onTelegramAuth(user) {
            try {
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });

                const data = await response.json();
                if (data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –†—É—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ username (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
        async function manualLogin() {
            const username = document.getElementById('manual-username').value.trim();
            if (!username) {
                alert('–í–≤–µ–¥–∏—Ç–µ username');
                return;
            }

            try {
                // –°–æ–∑–¥–∞—ë–º —Ñ–µ–π–∫–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
                const response = await fetch('/api/auth/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username })
                });

                const data = await response.json();
                if (data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                isAuthenticated = false;
                currentUser = null;
                showLoginScreen();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('stat-users').textContent = stats.total_users || 0;
                document.getElementById('stat-orders').textContent = stats.completed_orders || 0;
                document.getElementById('stat-revenue').textContent = `${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ`;
                document.getElementById('stat-generations').textContent = stats.total_generations || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`content-${tab}`).style.display = 'block';
            
            loadTabData(tab);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏
        async function loadTabData(tab) {
            const container = document.getElementById(`${tab}-table`);
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                let response;
                
                switch(tab) {
                    case 'users':
                        response = await fetch(`/api/users?page=${currentPage.users}&limit=50`);
                        const usersData = await response.json();
                        currentData.users = usersData;
                        renderUsers(usersData);
                        break;
                    case 'orders':
                        response = await fetch(`/api/orders?page=${currentPage.orders}&limit=50`);
                        const ordersData = await response.json();
                        currentData.orders = ordersData;
                        renderOrders(ordersData);
                        break;
                    case 'payments':
                        response = await fetch(`/api/payments?page=${currentPage.payments}&limit=50`);
                        const paymentsData = await response.json();
                        currentData.payments = paymentsData;
                        renderPayments(paymentsData);
                        break;
                    case 'jobs':
                        response = await fetch(`/api/did-jobs?page=${currentPage.jobs}&limit=50`);
                        const jobsData = await response.json();
                        currentData.jobs = jobsData;
                        renderJobs(jobsData);
                        break;
                }
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = document.getElementById('search-users').value;
                loadUsers(search);
            }, 300);
        }

        async function loadUsers(search = '') {
            const container = document.getElementById('users-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const url = search 
                    ? `/api/users?page=${currentPage.users}&limit=50&search=${encodeURIComponent(search)}`
                    : `/api/users?page=${currentPage.users}&limit=50`;
                
                const response = await fetch(url);
                const data = await response.json();
                currentData.users = data;
                renderUsers(data);
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsers(data) {
            const container = document.getElementById('users-table');
            
            if (!data.users || data.users.length === 0) {
                container.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Telegram ID</th>
                            <th>Username</th>
                            <th>–ò–º—è</th>
                            <th>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</th>
                            <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.telegram_id}</td>
                        <td>@${user.username || '-'}</td>
                        <td>${user.first_name || '-'} ${user.last_name || ''}</td>
                        <td>${user.generations || 0}</td>
                        <td class="timestamp">${new Date(user.created_at).toLocaleString('ru-RU')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editGenerations(${user.id}, '${user.username || user.first_name || 'User'}', ${user.generations || 0})">–ò–∑–º–µ–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.username || user.first_name || 'User'}')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn btn-primary btn-sm" onclick="viewUserHistory(${user.id})">–ò—Å—Ç–æ—Ä–∏—è</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            
            if (data.total > 50) {
                html += renderPagination('users', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤
        function renderOrders(data) {
            const container = document.getElementById('orders-table');
            
            if (!data.orders || data.orders.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ü—Ä–æ–º–ø—Ç</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.orders.forEach(order => {
                html += `
                    <tr>
                        <td><a href="#" onclick="viewOrderDetails('${order.id}')" class="link">${order.id.substring(0, 8)}...</a></td>
                        <td>@${order.username || order.telegram_id || '-'}</td>
                        <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                        <td>${order.price} ‚ÇΩ</td>
                        <td>${(order.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è').substring(0, 30)}${order.custom_prompt && order.custom_prompt.length > 30 ? '...' : ''}</td>
                        <td class="timestamp">${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            
            if (data.total > 50) {
                html += renderPagination('orders', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
        function renderPayments(data) {
            const container = document.getElementById('payments-table');
            
            if (!data.payments || data.payments.length === 0) {
                container.innerHTML = '<div class="empty">–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>YooMoney ID</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.payments.forEach(payment => {
                html += `
                    <tr>
                        <td>${payment.id.substring(0, 8)}...</td>
                        <td>@${payment.username || payment.telegram_id || '-'}</td>
                        <td>${payment.amount} ‚ÇΩ</td>
                        <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                        <td>${payment.yoomoney_payment_id || '-'}</td>
                        <td class="timestamp">${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            
            if (data.total > 50) {
                html += renderPagination('payments', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞–Ω–∏–π
        function renderJobs(data) {
            const container = document.getElementById('jobs-table');
            
            if (!data.jobs || data.jobs.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ü—Ä–æ–º–ø—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                            <th>–û—à–∏–±–∫–∞</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.jobs.forEach(job => {
                html += `
                    <tr>
                        <td>${job.id.substring(0, 8)}...</td>
                        <td>@${job.username || job.telegram_id || '-'}</td>
                        <td>${(job.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è').substring(0, 30)}${job.custom_prompt && job.custom_prompt.length > 30 ? '...' : ''}</td>
                        <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                        <td>${job.result_url ? `<a href="${job.result_url}" target="_blank" class="link">–°–º–æ—Ç—Ä–µ—Ç—å</a>` : '-'}</td>
                        <td>${job.error_message ? `<span style="color: red;">${job.error_message.substring(0, 50)}...</span>` : '-'}</td>
                        <td class="timestamp">${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            
            if (data.total > 50) {
                html += renderPagination('jobs', data);
            }
            
            container.innerHTML = html;
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function renderPagination(tab, data) {
            const totalPages = Math.ceil(data.total / 50);
            return `
                <div class="pagination">
                    <button ${currentPage[tab] === 1 ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] - 1})">‚Äπ –ù–∞–∑–∞–¥</button>
                    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage[tab]} –∏–∑ ${totalPages} (–≤—Å–µ–≥–æ: ${data.total})</span>
                    <button ${currentPage[tab] >= totalPages ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] + 1})">–í–ø–µ—Ä—ë–¥ ‚Ä∫</button>
                </div>
            `;
        }

        function changePage(tab, page) {
            currentPage[tab] = page;
            loadTabData(tab);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusBadge(status) {
            const statusMap = {
                'completed': 'success',
                'succeeded': 'success',
                'pending': 'pending',
                'processing': 'processing',
                'failed': 'failed',
                'running': 'processing'
            };
            return statusMap[status] || 'pending';
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
        let editingUserId = null;
        function editGenerations(userId, userName, currentGenerations) {
            editingUserId = userId;
            document.getElementById('edit-user-info').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName} (–¢–µ–∫—É—â–µ–µ: ${currentGenerations})`;
            document.getElementById('edit-generations-input').value = currentGenerations;
            document.getElementById('editGenerationsModal').classList.add('active');
        }

        async function saveGenerations() {
            const newValue = parseInt(document.getElementById('edit-generations-input').value);
            
            if (isNaN(newValue) || newValue < 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
                return;
            }

            try {
                const response = await fetch(`/api/users/${editingUserId}/generations`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ generations: newValue })
                });

                if (response.ok) {
                    closeModal('editGenerationsModal');
                    loadUsers();
                    loadStats();
                    alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let deletingUserId = null;
        function deleteUser(userId, userName) {
            deletingUserId = userId;
            document.getElementById('delete-user-info').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        async function confirmDeleteUser() {
            try {
                const response = await fetch(`/api/users/${deletingUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeModal('deleteUserModal');
                    loadUsers();
                    loadStats();
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function viewUserHistory(userId) {
            try {
                const response = await fetch(`/api/users/${userId}/history`);
                const history = await response.json();
                
                let historyText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${history.user.username || history.user.telegram_id}\n`;
                historyText += `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(history.user.created_at).toLocaleString('ru-RU')}\n`;
                historyText += `–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${history.user.generations || 0}\n\n`;
                historyText += `–ó–∞–∫–∞–∑–æ–≤: ${history.orders.length}\n`;
                historyText += `–ü–ª–∞—Ç–µ–∂–µ–π: ${history.payments.length}\n`;
                historyText += `–ó–∞–¥–∞–Ω–∏–π: ${history.jobs.length}\n`;
                
                alert(historyText);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkAuth();
    </script>
</body>
</html>

