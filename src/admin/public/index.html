<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header .stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .filters-container select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .filter-tag .filter-label {
            font-weight: 600;
        }

        .filter-tag .filter-value {
            font-weight: 400;
        }

        .filter-tag .filter-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .filter-tag .filter-remove:hover {
            opacity: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
            
            .actions {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn-sm {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            /* –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .table-responsive table,
            .table-responsive thead,
            .table-responsive tbody,
            .table-responsive th,
            .table-responsive td,
            .table-responsive tr {
                display: block;
            }
            
            .table-responsive thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-responsive tr {
                border: 1px solid #e0e0e0;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }
            
            .table-responsive td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: left;
            }
            
            .table-responsive td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 45%;
                font-weight: 600;
                color: #666;
            }

            /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
            .analytics-stats {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            .analytics-charts {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .analytics-chart-container {
                padding: 15px !important;
            }

            .analytics-chart-container canvas {
                max-height: 250px !important;
            }
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.success { background: #d4edda; color: #155724; }
        .badge.pending { background: #fff3cd; color: #856404; }
        .badge.failed { background: #f8d7da; color: #721c24; }
        .badge.processing { background: #d1ecf1; color: #0c5460; }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .toast-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .link {
            color: #667eea;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-card h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .telegram-login-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .telegram-login-button:hover {
            background: #006ba3;
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h2>
            <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
            <div id="telegram-login-container"></div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="mainContent" class="hidden">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üöÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Vividus Bot</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                <div class="value" id="stat-users">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ó–∞–∫–∞–∑—ã</div>
                <div class="value" id="stat-orders">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–í—ã—Ä—É—á–∫–∞</div>
                <div class="value" id="stat-revenue">-</div>
            </div>
            <div class="stat-item">
                <div class="label">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                <div class="value" id="stat-generations">-</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="tab" onclick="switchTab('orders')">üì¶ –ó–∞–∫–∞–∑—ã</button>
            <button class="tab" onclick="switchTab('payments')">üí≥ –ü–ª–∞—Ç–µ–∂–∏</button>
            <button class="tab" onclick="switchTab('jobs')">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
            <button class="tab" onclick="switchTab('analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            <button class="tab" onclick="switchTab('logs')">üìã –õ–æ–≥–∏</button>
        </div>

        <div class="content">
            <div id="content-users" class="tab-content">
                <div class="filters-container">
                    <input type="text" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, –∏–º–µ–Ω–∏ –∏–ª–∏ telegram_id..." 
                           oninput="searchUsers()"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-users-campaign" onchange="applyUsersFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div id="active-filters-users" class="active-filters"></div>
                <div id="users-table"></div>
            </div>

            <div id="content-orders" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-orders-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ id..." 
                           oninput="clearTimeout(orderSearchTimeout); orderSearchTimeout = setTimeout(() => loadOrders(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-orders-campaign" onchange="applyOrdersFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div id="active-filters-orders" class="active-filters"></div>
                <div id="orders-table"></div>
            </div>

            <div id="content-payments" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-payments-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ id..." 
                           oninput="clearTimeout(paymentSearchTimeout); paymentSearchTimeout = setTimeout(() => loadPayments(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-payments-campaign" onchange="applyPaymentsFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div id="active-filters-payments" class="active-filters"></div>
                <div id="payments-table"></div>
            </div>

            <div id="content-jobs" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-jobs-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ id..." 
                           oninput="clearTimeout(jobSearchTimeout); jobSearchTimeout = setTimeout(() => loadJobs(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-jobs-campaign" onchange="applyJobsFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div id="active-filters-jobs" class="active-filters"></div>
                <div id="jobs-table"></div>
            </div>

            <div id="content-analytics" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="search-analytics-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (username, telegram_id –∏–ª–∏ id) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–ª–æ—É..." 
                           oninput="clearTimeout(analyticsSearchTimeout); analyticsSearchTimeout = setTimeout(() => loadUserAnalytics(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="filter-analytics-campaign" onchange="loadAnalytics(); updateActiveFilters('analytics')" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div id="active-filters-analytics" class="active-filters"></div>
                <div id="analytics-content"></div>
                <div id="user-analytics-content" style="display: none;"></div>
            </div>

            <div id="content-logs" class="tab-content" style="display: none;">
                <div class="filters-container">
                    <input type="text" id="log-user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ username, telegram_id –∏–ª–∏ user_id..." 
                           oninput="clearTimeout(logSearchTimeout); logSearchTimeout = setTimeout(() => loadLogs(), 300);"
                           style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <select id="log-table-filter" onchange="loadLogs(); updateActiveFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</option>
                    </select>
                    <select id="log-action-filter" onchange="loadLogs(); updateActiveFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
                        <option value="INSERT">–°–æ–∑–¥–∞–Ω–∏–µ (INSERT)</option>
                        <option value="UPDATE">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (UPDATE)</option>
                        <option value="DELETE">–£–¥–∞–ª–µ–Ω–∏–µ (DELETE)</option>
                    </select>
                    <select id="filter-logs-campaign" onchange="applyLogsFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 200px;">
                        <option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>
                    </select>
                    <button onclick="clearAllLogs()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; white-space: nowrap;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏
                    </button>
                </div>
                <div id="active-filters-logs" class="active-filters"></div>
                <div id="logs-table"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π -->
    <div class="modal" id="editGenerationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
                <p id="edit-user-info"></p>
            </div>
            <div class="form-group">
                <label>–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π:</label>
                <input type="number" id="edit-generations-input" min="0">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveGenerations()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('editGenerationsModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</h2>
                <p id="delete-user-info"></p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" onclick="closeModal('deleteUserModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <p id="history-user-info"></p>
            </div>
            <div id="history-content" style="max-height: 60vh; overflow-y: auto;">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('historyModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤ -->
    <div class="modal" id="confirmDeleteLogsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –ª–æ–≥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteLogs()">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                <button class="btn" onclick="closeModal('confirmDeleteLogsModal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="toast-container"></div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 401 –æ—à–∏–±–æ–∫
        let isRefreshingAuth = false;
        let refreshQueue = [];

        // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è fetch —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ 401
        async function fetchWithAuth(url, options = {}) {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            const response = await fetch(url, options);
            
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (response.status === 401) {
                // –ï—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∂–¥–µ–º –µ–≥–æ
                if (isRefreshingAuth) {
                    return new Promise((resolve) => {
                        refreshQueue.push(() => {
                            resolve(fetchWithAuth(url, options));
                        });
                    });
                }
                
                isRefreshingAuth = true;
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    const refreshed = await refreshAuth();
                    
                    if (refreshed) {
                        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, –ø–æ–≤—Ç–æ—Ä—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                        const retryResponse = await fetch(url, options);
                        
                        // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                        refreshQueue.forEach(callback => callback());
                        refreshQueue = [];
                        isRefreshingAuth = false;
                        
                        return retryResponse;
                    } else {
                        // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        refreshQueue.forEach(callback => callback());
                        refreshQueue = [];
                        isRefreshingAuth = false;
                        
                        showToast('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'warning', '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                        showAuthRequiredModal();
                        
                        return response;
                    }
                } catch (error) {
                    refreshQueue.forEach(callback => callback());
                    refreshQueue = [];
                    isRefreshingAuth = false;
                    
                    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                    showAuthRequiredModal();
                    
                    return response;
                }
            }
            
            return response;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function refreshAuth() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Telegram WebApp API
                if (window.Telegram?.WebApp?.initData) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram WebApp –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    const initData = window.Telegram.WebApp.initData;
                    
                    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ initData
                    const params = new URLSearchParams(initData);
                    const authData = {};
                    params.forEach((value, key) => {
                        authData[key] = value;
                    });
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    const response = await fetch('/api/auth/telegram', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(authData),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.authenticated) {
                            return true;
                        }
                    }
                }
                
                // –ï—Å–ª–∏ Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
                const checkResponse = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    if (checkData.authenticated) {
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error refreshing auth:', error);
                return false;
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthRequiredModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'authRequiredModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                        <p>–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.</p>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="reloadPage()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                        <button class="btn" onclick="closeAuthModal()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAuthModal() {
            const modal = document.getElementById('authRequiredModal');
            if (modal) {
                modal.remove();
            }
        }

        function reloadPage() {
            window.location.reload();
        }

        // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showToast(message, type = 'info', title = null) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const titlesDefault = {
                success: '–£—Å–ø–µ—à–Ω–æ',
                error: '–û—à–∏–±–∫–∞',
                warning: '–í–Ω–∏–º–∞–Ω–∏–µ',
                info: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title || titlesDefault[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
        }

        let currentTab = 'users';
        let currentPage = { users: 1, orders: 1, payments: 1, jobs: 1 };
        let currentData = {};
        let searchTimeout = null;
        let logSearchTimeout = null;
        let orderSearchTimeout = null;
        let paymentSearchTimeout = null;
        let jobSearchTimeout = null;
        let analyticsSearchTimeout = null;
        let isAuthenticated = false;
        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            try {
                const response = await fetchWithAuth('/api/auth/check');
                const data = await response.json();
                if (data.authenticated) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                showLoginScreen();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            initTelegramLogin();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        function showMainContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = `@${currentUser.username || currentUser.telegram_id}`;
            }
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            loadCampaigns();
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π
        let campaignsList = [];
        async function loadCampaigns() {
            try {
                const response = await fetchWithAuth('/api/campaigns');
                campaignsList = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã –∫–∞–º–ø–∞–Ω–∏–π
                ['users', 'orders', 'payments', 'jobs', 'logs', 'analytics'].forEach(tab => {
                    const select = document.getElementById(`filter-${tab}-campaign`);
                    if (select) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        const currentValue = select.value;
                        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
                        select.innerHTML = '<option value="">–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏</option>';
                        campaignsList.forEach(campaign => {
                            const option = document.createElement('option');
                            option.value = campaign;
                            option.textContent = campaign;
                            select.appendChild(option);
                        });
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateActiveFilters(tab) {
            const container = document.getElementById(`active-filters-${tab}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const filters = [];
            
            // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const userSearch = document.getElementById(tab === 'users' ? 'search-users' : 
                                                       tab === 'orders' ? 'search-orders-user' :
                                                       tab === 'payments' ? 'search-payments-user' :
                                                       tab === 'jobs' ? 'search-jobs-user' :
                                                       tab === 'analytics' ? 'search-analytics-user' :
                                                       'log-user-search')?.value?.trim();
            if (userSearch) {
                filters.push({ type: 'user', label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', value: userSearch, clear: () => {
                    const input = document.getElementById(tab === 'users' ? 'search-users' : 
                                                          tab === 'orders' ? 'search-orders-user' :
                                                          tab === 'payments' ? 'search-payments-user' :
                                                          tab === 'jobs' ? 'search-jobs-user' :
                                                          tab === 'analytics' ? 'search-analytics-user' :
                                                          'log-user-search');
                    if (input) input.value = '';
                    if (tab === 'users') searchUsers();
                    else if (tab === 'orders') loadOrders();
                    else if (tab === 'payments') loadPayments();
                    else if (tab === 'jobs') loadJobs();
                    else if (tab === 'logs') loadLogs();
                    else if (tab === 'analytics') loadAnalytics();
                }});
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞–º–ø–∞–Ω–∏–∏
            const campaign = document.getElementById(`filter-${tab}-campaign`)?.value;
            if (campaign) {
                filters.push({ type: 'campaign', label: '–ö–∞–º–ø–∞–Ω–∏—è', value: campaign, clear: () => {
                    const select = document.getElementById(`filter-${tab}-campaign`);
                    if (select) select.value = '';
                    if (tab === 'users') applyUsersFilters();
                    else if (tab === 'orders') applyOrdersFilters();
                    else if (tab === 'payments') applyPaymentsFilters();
                    else if (tab === 'jobs') applyJobsFilters();
                    else if (tab === 'logs') applyLogsFilters();
                    else if (tab === 'analytics') loadAnalytics();
                }});
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ª–æ–≥–æ–≤
            if (tab === 'logs') {
                const tableFilter = document.getElementById('log-table-filter')?.value;
                if (tableFilter) {
                    filters.push({ type: 'table', label: '–¢–∞–±–ª–∏—Ü–∞', value: tableFilter, clear: () => {
                        const select = document.getElementById('log-table-filter');
                        if (select) select.value = '';
                        loadLogs();
                    }});
                }
                
                const actionFilter = document.getElementById('log-action-filter')?.value;
                if (actionFilter) {
                    filters.push({ type: 'action', label: '–î–µ–π—Å—Ç–≤–∏–µ', value: actionFilter, clear: () => {
                        const select = document.getElementById('log-action-filter');
                        if (select) select.value = '';
                        loadLogs();
                    }});
                }
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–µ–≥–∏
            filters.forEach((filter, index) => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                const removeId = `filter-remove-${tab}-${index}`;
                tag.innerHTML = `
                    <span class="filter-label">${filter.label}:</span>
                    <span class="filter-value">${filter.value}</span>
                    <span class="filter-remove" id="${removeId}">√ó</span>
                `;
                container.appendChild(tag);
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
                document.getElementById(removeId).addEventListener('click', (e) => {
                    e.stopPropagation();
                    filter.clear();
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyUsersFilters() {
            updateActiveFilters('users');
            searchUsers();
        }

        function applyOrdersFilters() {
            updateActiveFilters('orders');
            loadOrders();
        }

        function applyPaymentsFilters() {
            updateActiveFilters('payments');
            loadPayments();
        }

        function applyJobsFilters() {
            updateActiveFilters('jobs');
            loadJobs();
        }

        function applyLogsFilters() {
            updateActiveFilters('logs');
            loadLogs();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Widget Login
        async function initTelegramLogin() {
            const container = document.getElementById('telegram-login-container');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º bot username —á–µ—Ä–µ–∑ API
                const response = await fetch('/api/bot-username');
                const data = await response.json();
                const botUsername = data.botUsername;
                
                if (!botUsername) {
                    container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞: Bot username –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>';
                    return;
                }
                
                container.innerHTML = '';
                const script = document.createElement('script');
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
                script.src = 'https://telegram.org/js/telegram-widget.js?22&t=' + Date.now();
                script.setAttribute('data-telegram-login', botUsername);
                script.setAttribute('data-size', 'large');
                script.setAttribute('data-userpic', 'false');
                script.setAttribute('data-request-access', 'write');
                // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ auth-url –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                script.setAttribute('data-auth-url', window.location.origin + '/api/auth/telegram?t=' + Date.now());
                script.setAttribute('data-onauth', 'onTelegramAuth(user)');
                script.async = true;
                container.appendChild(script);
            } catch (error) {
                container.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞: ' + error.message + '</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram
        async function onTelegramAuth(user) {
            try {
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });

                const data = await response.json();
                if (data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    showMainContent();
                    loadStats();
                    loadUsers();
                } else {
                    showToast(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞', 'error', '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
        }


        // –í—ã—Ö–æ–¥
        async function logout() {
            try {
                // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                await fetch('/api/auth/logout', { method: 'POST' });
                
                // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                isAuthenticated = false;
                currentUser = null;
                
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Telegram Widget –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –µ–≥–æ
                const container = document.getElementById('telegram-login-container');
                if (container) {
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–≤–∫–ª—é—á–∞—è —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞)
                    container.innerHTML = '';
                }
                
                // –û—á–∏—â–∞–µ–º cookies (–µ—Å–ª–∏ –µ—Å—Ç—å)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // –û—á–∏—â–∞–µ–º localStorage –∏ sessionStorage (Telegram Widget –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö)
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
                }
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
                setTimeout(() => {
                    showLoginScreen();
                }, 100);
            } catch (error) {
                console.error('Logout error:', error);
                // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const container = document.getElementById('telegram-login-container');
                if (container) {
                    container.innerHTML = '';
                }
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                } catch (e) {}
                // –í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                setTimeout(() => {
                    showLoginScreen();
                }, 100);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetchWithAuth('/api/stats');
                const stats = await response.json();
                
                document.getElementById('stat-users').textContent = stats.total_users || 0;
                document.getElementById('stat-orders').textContent = stats.completed_orders || 0;
                document.getElementById('stat-revenue').textContent = `${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ`;
                document.getElementById('stat-generations').textContent = stats.total_generations || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`content-${tab}`).style.display = 'block';
            
            loadTabData(tab);
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏
            updateActiveFilters(tab);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∏
        async function loadTabData(tab) {
            let container;
            if (tab === 'analytics') {
                container = document.getElementById('analytics-content');
            } else if (tab === 'logs') {
                container = document.getElementById('logs-table');
            } else {
                container = document.getElementById(`${tab}-table`);
            }
            
            if (!container) {
                console.error(`Container not found for tab: ${tab}`);
                return;
            }
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                let response;
                
                switch(tab) {
                    case 'users':
                        response = await fetchWithAuth(`/api/users?page=${currentPage.users}&limit=50`);
                        const usersData = await response.json();
                        currentData.users = usersData;
                        renderUsers(usersData);
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'payments':
                        loadPayments();
                        break;
                    case 'jobs':
                        loadJobs();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                    case 'logs':
                        await loadLogTables();
                        loadLogs();
                        break;
                }
            } catch (error) {
                if (container) {
                    container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
                }
            }
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = document.getElementById('search-users').value;
                loadUsers(search);
            }, 300);
        }

        async function loadUsers(search = '') {
            const container = document.getElementById('users-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const campaign = document.getElementById('filter-users-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.users.toString(),
                    limit: '50'
                });
                if (search) params.append('search', search);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/users?${params.toString()}`);
                const data = await response.json();
                currentData.users = data;
                renderUsers(data);
                updateActiveFilters('users');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadOrders() {
            const container = document.getElementById('orders-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const userSearch = document.getElementById('search-orders-user')?.value || '';
                const campaign = document.getElementById('filter-orders-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.orders.toString(),
                    limit: '50'
                });
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/orders?${params.toString()}`);
                const data = await response.json();
                currentData.orders = data;
                renderOrders(data);
                updateActiveFilters('orders');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadPayments() {
            const container = document.getElementById('payments-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const userSearch = document.getElementById('search-payments-user')?.value || '';
                const campaign = document.getElementById('filter-payments-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.payments.toString(),
                    limit: '50'
                });
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/payments?${params.toString()}`);
                const data = await response.json();
                currentData.payments = data;
                renderPayments(data);
                updateActiveFilters('payments');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadJobs() {
            const container = document.getElementById('jobs-table');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                const userSearch = document.getElementById('search-jobs-user')?.value || '';
                const campaign = document.getElementById('filter-jobs-campaign')?.value || '';
                const params = new URLSearchParams({
                    page: currentPage.jobs.toString(),
                    limit: '50'
                });
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/did-jobs?${params.toString()}`);
                const data = await response.json();
                currentData.jobs = data;
                renderJobs(data);
                updateActiveFilters('jobs');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsers(data) {
            const container = document.getElementById('users-table');
            
            if (!data.users || data.users.length === 0) {
                container.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Telegram ID</th>
                                <th>Username</th>
                                <th>–ò–º—è</th>
                                <th>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</th>
                                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.telegram_id}</td>
                        <td>@${user.username || '-'}</td>
                        <td>${user.first_name || '-'} ${user.last_name || ''}</td>
                        <td>${user.generations || 0}</td>
                        <td class="timestamp">${new Date(user.created_at).toLocaleString('ru-RU')}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" onclick="editGenerations(${user.id}, '${user.username || user.first_name || 'User'}', ${user.generations || 0})">–ò–∑–º–µ–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.username || user.first_name || 'User'}')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn btn-primary btn-sm" onclick="viewUserHistory(${user.id})">–ò—Å—Ç–æ—Ä–∏—è</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('users', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤
        function renderOrders(data) {
            const container = document.getElementById('orders-table');
            
            if (!data.orders || data.orders.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¶–µ–Ω–∞</th>
                                <th>–ü—Ä–æ–º–ø—Ç</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.orders.forEach((order, index) => {
                const priceDisplay = order.price === 0 || order.price === null ? '1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è' : `${order.price} ‚ÇΩ`;
                const promptId = `prompt-${order.id}-${index}`;
                const promptText = order.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è';
                const isLongPrompt = promptText.length > 30;
                const shortPrompt = isLongPrompt ? promptText.substring(0, 30) + '...' : promptText;
                const imageUrl = order.original_file_path || '';
                const hasImage = imageUrl && (imageUrl.startsWith('http://') || imageUrl.startsWith('https://'));
                
                html += `
                    <tr>
                        <td><a href="#" onclick="viewOrderDetails('${order.id}')" class="link">${order.id.substring(0, 8)}...</a></td>
                        <td>@${order.username || order.telegram_id || '-'}</td>
                        <td>${hasImage ? `<a href="${imageUrl}" target="_blank" class="link" style="font-size: 11px;">üì∑ –û—Ç–∫—Ä—ã—Ç—å</a>` : '-'}</td>
                        <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                        <td>${priceDisplay}</td>
                        <td>
                            <span id="${promptId}-short">${shortPrompt}</span>
                            ${isLongPrompt ? `
                                <span id="${promptId}-full" style="display: none;">${promptText}</span>
                                <button class="btn btn-primary btn-sm" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="togglePrompt('${promptId}')">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                            ` : ''}
                        </td>
                        <td class="timestamp">${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('orders', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
        function renderPayments(data) {
            const container = document.getElementById('payments-table');
            
            if (!data.payments || data.payments.length === 0) {
                container.innerHTML = '<div class="empty">–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>YooMoney ID</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.payments.forEach(payment => {
                html += `
                    <tr>
                        <td>${payment.id.substring(0, 8)}...</td>
                        <td>@${payment.username || payment.telegram_id || '-'}</td>
                        <td>${payment.amount} ‚ÇΩ</td>
                        <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                        <td>${payment.yoomoney_payment_id || '-'}</td>
                        <td class="timestamp">${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('payments', data);
            }
            
            container.innerHTML = html;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞–Ω–∏–π
        function renderJobs(data) {
            const container = document.getElementById('jobs-table');
            
            if (!data.jobs || data.jobs.length === 0) {
                container.innerHTML = '<div class="empty">–ó–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–º–ø—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–û—à–∏–±–∫–∞</th>
                                <th>–°–æ–∑–¥–∞–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.jobs.forEach((job, index) => {
                const promptId = `job-prompt-${job.id}-${index}`;
                const promptText = job.custom_prompt || '–ë–∞–∑–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è';
                const isLongPrompt = promptText.length > 30;
                const shortPrompt = isLongPrompt ? promptText.substring(0, 30) + '...' : promptText;
                
                html += `
                    <tr>
                        <td>${job.id.substring(0, 8)}...</td>
                        <td>@${job.username || job.telegram_id || '-'}</td>
                        <td>
                            <span id="${promptId}-short">${shortPrompt}</span>
                            ${isLongPrompt ? `
                                <span id="${promptId}-full" style="display: none;">${promptText}</span>
                                <button class="btn btn-primary btn-sm" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="togglePrompt('${promptId}')">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                            ` : ''}
                        </td>
                        <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                        <td>${job.result_url ? `<a href="${job.result_url}" target="_blank" class="link">–°–º–æ—Ç—Ä–µ—Ç—å</a>` : '-'}</td>
                        <td>${job.error_message ? `<span style="color: red;">${job.error_message.substring(0, 50)}...</span>` : '-'}</td>
                        <td class="timestamp">${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 50) {
                html += renderPagination('jobs', data);
            }
            
            container.innerHTML = html;
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function renderPagination(tab, data) {
            const totalPages = Math.ceil(data.total / 50);
            return `
                <div class="pagination">
                    <button ${currentPage[tab] === 1 ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] - 1})">‚Äπ –ù–∞–∑–∞–¥</button>
                    <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage[tab]} –∏–∑ ${totalPages} (–≤—Å–µ–≥–æ: ${data.total})</span>
                    <button ${currentPage[tab] >= totalPages ? 'disabled' : ''} onclick="changePage('${tab}', ${currentPage[tab] + 1})">–í–ø–µ—Ä—ë–¥ ‚Ä∫</button>
                </div>
            `;
        }

        function changePage(tab, page) {
            currentPage[tab] = page;
            loadTabData(tab);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusBadge(status) {
            const statusMap = {
                'completed': 'success',
                'succeeded': 'success',
                'success': 'success',
                'pending': 'pending',
                'processing': 'processing',
                'failed': 'failed',
                'running': 'processing',
                'canceled': 'failed',
                'cancelled': 'failed'
            };
            return statusMap[status?.toLowerCase()] || 'pending';
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
        let editingUserId = null;
        function editGenerations(userId, userName, currentGenerations) {
            editingUserId = userId;
            document.getElementById('edit-user-info').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName} (–¢–µ–∫—É—â–µ–µ: ${currentGenerations})`;
            document.getElementById('edit-generations-input').value = currentGenerations;
            document.getElementById('editGenerationsModal').classList.add('active');
        }

        async function saveGenerations() {
            const newValue = parseInt(document.getElementById('edit-generations-input').value);
            
            if (isNaN(newValue) || newValue < 0) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ', 'error', '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏');
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/users/${editingUserId}/generations`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ generations: newValue })
                });

                if (response.ok) {
                    closeModal('editGenerationsModal');
                    loadUsers();
                    loadStats();
                    showToast('–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let deletingUserId = null;
        function deleteUser(userId, userName) {
            deletingUserId = userId;
            document.getElementById('delete-user-info').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
            document.getElementById('deleteUserModal').classList.add('active');
        }

        async function confirmDeleteUser() {
            try {
                const response = await fetchWithAuth(`/api/users/${deletingUserId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeModal('deleteUserModal');
                    loadUsers();
                    loadStats();
                    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }));
                    showToast(errorData.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                }
            } catch (error) {
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞
        function togglePrompt(promptId) {
            const shortEl = document.getElementById(`${promptId}-short`);
            const fullEl = document.getElementById(`${promptId}-full`);
            const button = event.target;
            
            if (shortEl && fullEl && button) {
                if (shortEl.style.display === 'none') {
                    shortEl.style.display = 'inline';
                    fullEl.style.display = 'none';
                    button.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
                } else {
                    shortEl.style.display = 'none';
                    fullEl.style.display = 'inline';
                    button.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function viewUserHistory(userId) {
            try {
                document.getElementById('historyModal').classList.add('active');
                const content = document.getElementById('history-content');
                content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                
                const response = await fetchWithAuth(`/api/users/${userId}/history`);
                const history = await response.json();
                
                const user = history.user;
                document.getElementById('history-user-info').textContent = 
                    `@${user.username || user.telegram_id} | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(user.created_at).toLocaleString('ru-RU')} | –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${user.generations || 0}`;
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üì¶ –ó–∞–∫–∞–∑—ã (${history.orders.length})</h3>
                        ${history.orders.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–¶–µ–Ω–∞</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.orders.map(order => `
                                            <tr>
                                                <td>${order.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(order.status)}">${order.status}</span></td>
                                                <td>${order.price || 0} ‚ÇΩ</td>
                                                <td>${new Date(order.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üí≥ –ü–ª–∞—Ç–µ–∂–∏ (${history.payments.length})</h3>
                        ${history.payments.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–°—É–º–º–∞</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.payments.map(payment => `
                                            <tr>
                                                <td>${payment.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(payment.status)}">${payment.status}</span></td>
                                                <td>${payment.amount} ‚ÇΩ</td>
                                                <td>${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</p>'}
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üé¨ –ó–∞–¥–∞–Ω–∏—è (${history.jobs.length})</h3>
                        ${history.jobs.length > 0 ? `
                            <div class="table-wrapper">
                                <table style="font-size: 12px;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–î–∞—Ç–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${history.jobs.map(job => `
                                            <tr>
                                                <td>${job.id.substring(0, 8)}...</td>
                                                <td><span class="badge ${getStatusBadge(job.status)}">${job.status}</span></td>
                                                <td>${new Date(job.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: #999;">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</p>'}
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                document.getElementById('history-content').innerHTML = 
                    `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</div>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        async function loadAnalytics() {
            const userSearch = document.getElementById('search-analytics-user')?.value || '';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (userSearch) {
                await loadUserAnalytics(userSearch);
                return;
            }
            
            // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
            const container = document.getElementById('analytics-content');
            const userContainer = document.getElementById('user-analytics-content');
            
            container.style.display = 'block';
            userContainer.style.display = 'none';
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>';
            
            try {
                const campaign = document.getElementById('filter-analytics-campaign')?.value || '';
                const statsUrl = campaign ? `/api/stats?campaign=${encodeURIComponent(campaign)}` : '/api/stats';
                
                const [campaignsResponse, statsResponse] = await Promise.all([
                    fetchWithAuth('/api/analytics/campaigns'),
                    fetchWithAuth(statsUrl)
                ]);
                
                const campaigns = await campaignsResponse.json();
                const stats = await statsResponse.json();
                
                renderAnalytics(campaigns, stats);
                updateActiveFilters('analytics');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadUserAnalytics(userSearch = null) {
            const search = userSearch || document.getElementById('search-analytics-user')?.value || '';
            
            if (!search) {
                document.getElementById('analytics-content').style.display = 'block';
                document.getElementById('user-analytics-content').style.display = 'none';
                loadAnalytics();
                return;
            }

            const container = document.getElementById('analytics-content');
            const userContainer = document.getElementById('user-analytics-content');
            
            container.style.display = 'none';
            userContainer.style.display = 'block';
            userContainer.innerHTML = '<div class="loading">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>';

            try {
                // –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º user_id
                const userSearchResponse = await fetchWithAuth(`/api/users?search=${encodeURIComponent(search)}&limit=1`);
                const userSearchData = await userSearchResponse.json();
                
                if (!userSearchData.users || userSearchData.users.length === 0) {
                    userContainer.innerHTML = '<div class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                    return;
                }

                const userId = userSearchData.users[0].id;
                
                // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const analyticsResponse = await fetchWithAuth(`/api/analytics/user/${userId}`);
                const analytics = await analyticsResponse.json();
                
                renderUserAnalytics(analytics);
            } catch (error) {
                userContainer.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}</div>`;
            }
        }

        function renderUserAnalytics(data) {
            const container = document.getElementById('user-analytics-content');
            
            const flowSteps = [
                { name: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', passed: data.flow.registered, icon: '‚úÖ' },
                { name: '–°–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑ (–æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ)', passed: data.flow.has_orders, icon: data.flow.has_orders ? '‚úÖ' : '‚ùå' },
                { name: '–û–ø–ª–∞—Ç–∏–ª / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', passed: data.flow.has_payments, icon: data.flow.has_payments ? '‚úÖ' : '‚ùå' },
                { name: '–ó–∞–≤–µ—Ä—à–∏–ª –∑–∞–∫–∞–∑ (–ø–æ–ª—É—á–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)', passed: data.flow.has_completed, icon: data.flow.has_completed ? '‚úÖ' : '‚ùå' }
            ];
            
            const allPassed = flowSteps.every(step => step.passed);
            const completionRate = data.flow.completion_rate;

            let html = `
                <div style="margin-bottom: 30px;">
                    <h2 style="margin-bottom: 15px;">üë§ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                                <div style="font-size: 16px; font-weight: bold;">@${data.user.username || data.user.telegram_id || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 2px;">ID: ${data.user.id} | Telegram: ${data.user.telegram_id}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.user.generations || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                                <div style="font-size: 14px;">${new Date(data.user.created_at).toLocaleDateString('ru-RU')}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">üîÑ –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ñ–ª–æ—É</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold;">–°—Ç–∞—Ç—É—Å:</span>
                                <span style="font-size: 18px; font-weight: bold; color: ${allPassed ? '#28a745' : '#ffc107'};">
                                    ${allPassed ? '‚úÖ –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –ø—Ä–æ–π–¥–µ–Ω' : '‚ö†Ô∏è –§–ª–æ—É –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω'}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:</span>
                                <span style="font-size: 18px; font-weight: bold;">${completionRate}%</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${flowSteps.map(step => `
                                <div style="padding: 15px; background: ${step.passed ? '#d4edda' : '#f8d7da'}; border-radius: 6px; border-left: 4px solid ${step.passed ? '#28a745' : '#dc3545'};">
                                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">
                                        ${step.icon} ${step.name}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        ${step.passed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">üì¶ –ó–∞–∫–∞–∑—ã</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.orders.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.orders.completed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${data.orders.failed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${data.orders.pending}</div>
                            </div>
                        </div>
                        ${data.orders.generations_orders > 0 ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <div style="font-size: 12px; color: #666;">–ó–∞–∫–∞–∑—ã –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                                <div style="font-size: 18px; font-weight: bold;">${data.orders.generations_orders}</div>
                            </div>
                        ` : ''}
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">üí≥ –ü–ª–∞—Ç–µ–∂–∏</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.payments.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.payments.successful}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–û–∂–∏–¥–∞—é—Ç</div>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${data.payments.pending}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${parseFloat(data.payments.total_spent).toFixed(2)} ‚ÇΩ</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px;">üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 12px; color: #666;">–í—Å–µ–≥–æ</div>
                                <div style="font-size: 24px; font-weight: bold;">${data.jobs.total}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.jobs.completed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${data.jobs.failed}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #666;">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</div>
                                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${data.jobs.processing}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function renderAnalytics(campaigns, stats) {
            const container = document.getElementById('analytics-content');
            
            let html = `
                <h2 style="margin-bottom: 20px;">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="analytics-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–í—ã—Ä—É—á–∫–∞</div>
                        <div style="font-size: 24px; font-weight: bold;">${parseFloat(stats.total_revenue || 0).toFixed(2)} ‚ÇΩ</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–£—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.successful_payments || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.completed_orders || 0}</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">–ü—Ä–æ–≤–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: bold;">${stats.failed_orders || 0}</div>
                    </div>
                </div>
                
                ${stats.flow ? `
                    <h2 style="margin-bottom: 20px; margin-top: 40px; font-size: ${window.innerWidth <= 768 ? '18px' : '20px'};">üîÑ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ñ–ª–æ—É</h2>
                    <div style="background: white; padding: ${window.innerWidth <= 768 ? '15px' : '30px'}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 40px;">
                        <p style="font-size: ${window.innerWidth <= 768 ? '11px' : '12px'}; color: #666; margin-bottom: 20px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ—à–ª–∏ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ñ–ª–æ—É: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ ‚Üí –æ–ø–ª–∞—Ç–∞/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 15px; max-width: 600px; margin: 0 auto;">
                            ${getFlowStepHtml('1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ', stats.flow.registered, stats.flow.registered, 100, '#667eea')}
                            ${getFlowStepHtml('2. –°–æ–∑–¥–∞–ª–∏ –∑–∞–∫–∞–∑ (–æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ñ–æ—Ç–æ)', stats.flow.created_order, stats.flow.registered, parseFloat(stats.flow.conversion_registered_to_order), '#48bb78', `‚Üì ${stats.flow.conversion_registered_to_order}%`)}
                            ${getFlowStepHtml('3. –û–ø–ª–∞—Ç–∏–ª–∏ / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', stats.flow.paid_or_used_generations, stats.flow.created_order, parseFloat(stats.flow.conversion_order_to_paid), '#ed8936', `‚Üì ${stats.flow.conversion_order_to_paid}%`)}
                            ${getFlowStepHtml('4. –ó–∞–≤–µ—Ä—à–∏–ª–∏ –∑–∞–∫–∞–∑ (–ø–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)', stats.flow.completed_order, stats.flow.paid_or_used_generations, parseFloat(stats.flow.conversion_paid_to_completed), '#38b2ac', `‚Üì ${stats.flow.conversion_paid_to_completed}%`)}
                        </div>
                        <div style="margin-top: 20px; padding: ${window.innerWidth <= 768 ? '10px' : '15px'}; background: #f8f9fa; border-radius: 6px; text-align: center;">
                            <div style="font-size: ${window.innerWidth <= 768 ? '11px' : '12px'}; color: #666; margin-bottom: 5px;">–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                            <div style="font-size: ${window.innerWidth <= 768 ? '20px' : '24px'}; font-weight: bold; color: #667eea;">${stats.flow.overall_conversion}%</div>
                            <div style="font-size: ${window.innerWidth <= 768 ? '10px' : '11px'}; color: #999; margin-top: 5px;">${stats.flow.completed_order} –∏–∑ ${stats.flow.registered} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∑–∞–∫–∞–∑</div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="analytics-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 8px; font-size: 16px;">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–æ–≤</h3>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∑–∞–∫–∞–∑—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã.
                        </p>
                        <div style="position: relative; height: 250px;">
                            <canvas id="ordersChart"></canvas>
                        </div>
                    </div>
                    <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 8px; font-size: 16px;">–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏–π</h3>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">
                            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –≤–∏–¥–µ–æ –≤ RunwayML. –ö–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                        </p>
                        <div style="position: relative; height: 250px;">
                            <canvas id="jobsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <h2 style="margin-bottom: 20px; margin-top: 40px;">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h2>
                ${campaigns.length > 0 ? `
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                                    <th>–í—ã—Ä—É—á–∫–∞ (‚≠ê)</th>
                                    <th>–ó–∞–∫–∞–∑—ã</th>
                                    <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(c => `
                                    <tr>
                                        <td>${c.campaign_name || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏'}</td>
                                        <td>${c.total_users || 0}</td>
                                        <td>${parseFloat(c.total_payments_rub || 0).toFixed(2)}</td>
                                        <td>${c.total_payments_stars || 0}</td>
                                        <td>${c.completed_orders || 0}</td>
                                        <td>${parseFloat(c.conversion_rate || 0).toFixed(2)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    ${campaigns.length > 0 ? `
                        <div style="margin-top: 40px;">
                            <div class="analytics-chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin-bottom: 15px; font-size: 16px;">–í—ã—Ä—É—á–∫–∞ –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º</h3>
                                <div style="position: relative; height: 350px;">
                                    <canvas id="campaignsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                ` : '<p style="color: #999;">–î–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º –Ω–µ—Ç</p>'}
            `;
            
            container.innerHTML = html;
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º
            setTimeout(() => {
                drawOrdersChart(stats);
                drawJobsChart(stats);
                if (campaigns.length > 0) {
                    drawCampaignsChart(campaigns);
                }
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —à–∞–≥–∞ –≤–æ—Ä–æ–Ω–∫–∏
        function getFlowStepHtml(label, current, previous, percentage, color, conversionText = '') {
            const width = previous > 0 ? (current / previous * 100) : 0;
            const isMobile = window.innerWidth <= 768;
            return `
                <div style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 5px;">
                        <span style="font-weight: 600; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 200px;' : ''}">${label}</span>
                        <span style="font-size: ${isMobile ? '16px' : '18px'}; font-weight: bold; color: ${color};">${current}</span>
                    </div>
                    ${conversionText ? `
                        <div style="text-align: center; margin-bottom: 5px; font-size: ${isMobile ? '10px' : '11px'}; color: #999;">${conversionText}</div>
                    ` : ''}
                    <div style="height: ${isMobile ? '35px' : '40px'}; background: #e9ecef; border-radius: 6px; overflow: hidden; position: relative;">
                        <div style="height: 100%; width: ${width}%; background: linear-gradient(90deg, ${color} 0%, ${color}dd 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-weight: bold; font-size: ${isMobile ? '11px' : '12px'}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">${percentage.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        let ordersChart = null;
        let jobsChart = null;
        let campaignsChart = null;

        function drawOrdersChart(stats) {
            const canvas = document.getElementById('ordersChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (ordersChart) {
                ordersChart.destroy();
            }
            
            const completed = stats.completed_orders || 0;
            const failed = stats.failed_orders || 0;
            
            ordersChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['–ó–∞–≤–µ—Ä—à–µ–Ω–æ', '–ü—Ä–æ–≤–∞–ª–µ–Ω–æ'],
                    datasets: [{
                        data: [completed, failed],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawJobsChart(stats) {
            const canvas = document.getElementById('jobsChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (jobsChart) {
                jobsChart.destroy();
            }
            
            const completed = stats.completed_jobs || 0;
            const failed = stats.failed_jobs || 0;
            
            jobsChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['–ó–∞–≤–µ—Ä—à–µ–Ω–æ', '–ü—Ä–æ–≤–∞–ª–µ–Ω–æ'],
                    datasets: [{
                        data: [completed, failed],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawCampaignsChart(campaigns) {
            const canvas = document.getElementById('campaignsChart');
            if (!canvas) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (campaignsChart) {
                campaignsChart.destroy();
            }
            
            const labels = campaigns.map(c => c.campaign_name || '–ë–µ–∑ –∫–∞–º–ø–∞–Ω–∏–∏');
            const revenues = campaigns.map(c => parseFloat(c.total_payments_rub || 0));
            
            campaignsChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                        data: revenues,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `–í—ã—Ä—É—á–∫–∞: ${context.parsed.y.toFixed(2)} ‚ÇΩ`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ‚ÇΩ';
                                },
                                font: {
                                    size: window.innerWidth <= 768 ? 10 : 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: window.innerWidth <= 768 ? 90 : 45,
                                minRotation: window.innerWidth <= 768 ? 90 : 45,
                                font: {
                                    size: window.innerWidth <= 768 ? 9 : 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
        async function loadLogTables() {
            try {
                const response = await fetchWithAuth('/api/logs/tables');
                const tables = await response.json();
                
                const select = document.getElementById('log-table-filter');
                if (select) {
                    // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
                    select.innerHTML = '<option value="">–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã</option>';
                    tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading log tables:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
        async function loadLogs(page = 1) {
            const container = document.getElementById('logs-table');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>';

            try {
                const tableFilter = document.getElementById('log-table-filter')?.value || '';
                const actionFilter = document.getElementById('log-action-filter')?.value || '';
                const userSearch = document.getElementById('log-user-search')?.value || '';
                const campaign = document.getElementById('filter-logs-campaign')?.value || '';
                
                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '100'
                });
                if (tableFilter) params.append('table', tableFilter);
                if (actionFilter) params.append('action', actionFilter);
                if (userSearch) params.append('user', userSearch);
                if (campaign) params.append('campaign', campaign);
                
                const response = await fetchWithAuth(`/api/logs?${params.toString()}`);
                const data = await response.json();
                renderLogs(data);
                updateActiveFilters('logs');
            } catch (error) {
                container.innerHTML = `<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ${error.message}</div>`;
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤
        function clearAllLogs() {
            document.getElementById('confirmDeleteLogsModal').classList.add('active');
        }

        async function confirmDeleteLogs() {
            try {
                const response = await fetchWithAuth('/api/logs', {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showToast(error.error || error.details || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞', 'error');
                    closeModal('confirmDeleteLogsModal');
                    return;
                }
                
                const result = await response.json();
                showToast(`–£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.deletedCount || 0}`, 'success', result.message || '–õ–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã');
                
                closeModal('confirmDeleteLogsModal');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
                loadLogs(1);
            } catch (error) {
                console.error('Error clearing logs:', error);
                showToast(error.message, 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ª–æ–≥–æ–≤');
                closeModal('confirmDeleteLogsModal');
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
        function renderLogs(data) {
            const container = document.getElementById('logs-table');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            if (data.message) {
                container.innerHTML = `
                    <div class="empty" style="padding: 40px; text-align: center;">
                        <p style="margin-bottom: 15px; font-size: 16px; color: #856404;">‚ö†Ô∏è ${data.message}</p>
                        <p style="color: #666; font-size: 14px;">
                            –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:<br>
                            <code style="background: #f8f9fa; padding: 5px 10px; border-radius: 4px; margin-top: 10px; display: inline-block;">
                                docker compose exec app npm run migrate
                            </code>
                        </p>
                    </div>
                `;
                return;
            }
            
            if (!data.logs || data.logs.length === 0) {
                container.innerHTML = '<div class="empty">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–¢–∞–±–ª–∏—Ü–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                <th>ID –∑–∞–ø–∏—Å–∏</th>
                                <th>–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è</th>
                                <th>–î–∞–Ω–Ω—ã–µ</th>
                                <th>–í—Ä–µ–º—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.logs.forEach((log, index) => {
                const actionColors = {
                    'INSERT': 'success',
                    'UPDATE': 'pending',
                    'DELETE': 'failed'
                };
                const actionLabels = {
                    'INSERT': '–°–æ–∑–¥–∞–Ω–∏–µ',
                    'UPDATE': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
                    'DELETE': '–£–¥–∞–ª–µ–Ω–∏–µ'
                };
                const actionColor = actionColors[log.action] || 'pending';
                const changedFields = log.changed_fields ? log.changed_fields.join(', ') : '-';
                const dataId = `log-data-${log.id}-${index}`;
                const hasOldData = log.old_data && Object.keys(log.old_data).length > 0;
                const hasNewData = log.new_data && Object.keys(log.new_data).length > 0;
                const userDisplay = log.username ? `@${log.username}` : (log.telegram_id ? `ID: ${log.telegram_id}` : (log.user_id ? `User ID: ${log.user_id}` : '-'));
                
                html += `
                    <tr>
                        <td>${log.id}</td>
                        <td>${userDisplay}</td>
                        <td><strong>${log.table_name}</strong></td>
                        <td><span class="badge ${actionColor}">${actionLabels[log.action] || log.action}</span></td>
                        <td style="font-family: monospace; font-size: 11px;">${log.record_id}</td>
                        <td style="font-size: 11px;">${changedFields}</td>
                        <td>
                            ${hasOldData || hasNewData ? `
                                <button class="btn btn-primary btn-sm" style="padding: 2px 6px; font-size: 10px;" onclick="toggleLogData('${dataId}')">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                                </button>
                                <div id="${dataId}" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                                    ${hasOldData ? `<div style="margin-bottom: 10px;"><strong>–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong><pre style="margin-top: 5px; font-size: 10px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(log.old_data, null, 2)}</pre></div>` : ''}
                                    ${hasNewData ? `<div><strong>–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong><pre style="margin-top: 5px; font-size: 10px; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(log.new_data, null, 2)}</pre></div>` : ''}
                                </div>
                            ` : '-'}
                        </td>
                        <td class="timestamp">${new Date(log.created_at).toLocaleString('ru-RU')}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            
            if (data.total > 100) {
                const totalPages = Math.ceil(data.total / 100);
                html += `
                    <div class="pagination">
                        <button onclick="loadLogs(${Math.max(1, data.page - 1)})" ${data.page === 1 ? 'disabled' : ''}>–ù–∞–∑–∞–¥</button>
                        <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.page} –∏–∑ ${totalPages} (–í—Å–µ–≥–æ: ${data.total})</span>
                        <button onclick="loadLogs(${Math.min(totalPages, data.page + 1)})" ${data.page === totalPages ? 'disabled' : ''}>–í–ø–µ—Ä–µ–¥</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ª–æ–≥–∞
        function toggleLogData(dataId) {
            const element = document.getElementById(dataId);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkAuth();
    </script>
</body>
</html>

